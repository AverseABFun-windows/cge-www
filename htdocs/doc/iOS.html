<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#_supported_ios_devices">Supported iOS Devices</a></li>
<li><a href="#_overview_and_examples">Overview and Examples</a></li>
<li><a href="#_building_the_app">Building the App</a>
<ul class="sectlevel1">
<li><a href="#_get_macos_and_xcode">1. Get macOS and Xcode</a></li>
<li><a href="#_install_fpc_for_macos">2. Install FPC for macOS</a></li>
<li><a href="#_installing_fpc_cross_compilers_for_iphone_and_iphonesimulator">3. Installing FPC cross-compilers for iPhone and iPhoneSimulator</a></li>
<li><a href="#_testing_fpc_cross_compilers">4. Testing FPC cross-compilers</a></li>
<li><a href="#_iphone_simulator_is_not_an_iphone_emulator">5. iPhone Simulator is not an iPhone emulator</a></li>
<li><a href="#_using_the_build_tool">6. Using the build tool</a></li>
<li><a href="#_archive_deploy_on_ios">7. Archive (deploy on iOS)</a></li>
<li><a href="#_upload_to_testflight_and_appstore">8. Upload to TestFlight and AppStore</a></li>
</ul>
</li>
<li><a href="#_debugging_the_pascal_code_without_ios">Debugging the Pascal Code without iOS</a></li>
<li><a href="#_known_problems">Known problems</a></li>
<li><a href="#_more_information_about_fpc_and_ios">More information about FPC and iOS</a></li>
<li><a href="#_alternative_using_fpc_trunk_unstable">Alternative: Using FPC trunk (unstable)</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Table of Contents:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#supported-ios-devices">Supported iOS Devices</a></p>
</li>
<li>
<p><a href="#overview-and-examples">Overview and Examples</a></p>
</li>
<li>
<p><a href="#building-the-app">Building the App</a></p>
<div class="ulist">
<ul>
<li>
<p><a href="#get-macos-and-xcode">Get macOS and Xcode</a></p>
</li>
<li>
<p><a href="#install-fpc-for-macos">Install FPC for macOS</a></p>
</li>
<li>
<p><a href="#installing-fpc-cross-compilers-for-iphone-and-iphonesimulator">Installing FPC cross-compilers for iPhone and iPhoneSimulator</a></p>
</li>
<li>
<p><a href="#testing-fpc-cross-compilers">Testing FPC cross-compilers</a></p>
</li>
<li>
<p><a href="#iphone-simulator-is-not-an-iphone-emulator">iPhone Simulator is not an iPhone emulator</a></p>
</li>
<li>
<p><a href="#using-the-build-tool">Using the build tool</a></p>
</li>
<li>
<p><a href="#archive-deploy-on-ios">Archive (deploy on iOS)</a></p>
</li>
<li>
<p><a href="#upload-to-testflight-and-appstore">Upload to TestFlight and AppStore</a></p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#debugging-the-pascal-code-without-ios">Debugging the Pascal Code without iOS</a></p>
</li>
<li>
<p><a href="#known-problems">Known problems</a></p>
</li>
<li>
<p><a href="#more-information-about-fpc-and-ios">More information about FPC and iOS</a></p>
</li>
<li>
<p><a href="#alternative-using-fpc-trunk-unstable">Alternative: Using FPC trunk (unstable)</a></p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_supported_ios_devices" class="sect0">Supported iOS Devices</h1>
<div class="openblock partintro">
<div class="content">
The engine should work with all devices running iOS 4.2 or newer. It was successfully tested with iOS 5.1, 7, 10, 11, 13, 14. The engine runs flawlessly on iPhone Simulator as well.
</div>
</div>
<h1 id="_overview_and_examples" class="sect0">Overview and Examples</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>There are two ways to use the engine on iOS:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The advised (and easier) way is to use the <a href="build tool" class="bare">build tool</a> to compile and package your game for iOS. Doing it is a matter of preparing <a href="CastleEngineManifest.xml examples">CastleEngineManifest.xml</a> for your project (with <code>game_units</code> or <code>ios_source</code> defined), and then running <code>castle-engine package --target=ios</code>. This gives you a ready project that you can open, run and publish from Xcode. <strong>This is the advised approach if you develop games using Object Pascal</strong>.</p>
<div class="paragraph">
<p>Various engine examples demonstrate this approach. Try e.g. <code>examples/2d_dragon_spine_game/</code> or <code>examples/2d_standard_ui/zombie_fighter/</code> .</p>
</div>
</li>
<li>
<p>An alternative way is to use the engine as a library that exposes a simple functionality of a VRML/X3D viewer. You can use this in your own custom Xcode projects. <strong>This approach is useful if you want to use the engine as a VRML/X3D file viewer, and wrap it in a custom user-interface in Xcode</strong>.</p>
<div class="paragraph">
<p>The library API is defined in the <code>src/library</code> directory of the engine. An example application using this approach is located in <code>examples/library/ios_tester</code>.</p>
</div>
<div class="paragraph">
<p>This approach is documented in more details on <a href="iOS Using the Custom Xcode Project" class="bare">iOS Using the Custom Xcode Project</a> page.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<h1 id="_building_the_app" class="sect0">Building the App</h1>
<div class="sect1">
<h2 id="_get_macos_and_xcode">1. Get macOS and Xcode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You will need any Mac computer with Xcode installed (available in Mac App Store, free).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you browse the documentation on <a href="http://wiki.freepascal.org/iPhone/iPod_development" class="bare">http://wiki.freepascal.org/iPhone/iPod_development</a> , it will talk about Xcode templates and proprietary iOS SDK headers. For the sake of developing games using Castle Game Engine, this can be ignored&#8201;&#8212;&#8201;we don&#8217;t need these headers or templates (since our entire GUI is drawn using GLES through Castle Game Engine).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Install also <a href="iOS_Services#common-notes-for-services-using-cocoapods">CocoaPods</a> by <code>sudo gem install cocoapods</code> in the terminal.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_install_fpc_for_macos">2. Install FPC for macOS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You will need to install this before installing the cross-compiler.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Go to <a href="https://sourceforge.net/projects/freepascal/files/Mac%20OS%20X/" class="bare">https://sourceforge.net/projects/freepascal/files/Mac%20OS%20X/</a></p>
</li>
<li>
<p>Select 3.2.0. (Usually we suggest here using the latest stable version, which is 3.2.2 now, but right now 3.2.2 has no precompiled cross-compiler for iOS.)</p>
</li>
<li>
<p>Download the regular compiler (for macOS) from there (like <code>fpc-3.2.0.intel-macosx.dmg</code> at the time of writing this).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The FPC compiler needs the "Xcode command-line developer tools" installed. In short, open <em>/Applications/Utilities/Terminal</em> and execute <code>xcode-select --install</code>.</p>
</div>
<div class="paragraph">
<p>Alternative approach to the installation is to use <a href="fpcupdeluxe">fpcupdeluxe</a>. This works now great with latest stable FPC 3.2.2. You can install the regular FPC/Lazarus, and then the necessary cross-compilers (iOS/arm, iOS/aarch64, i-sim/x86_64).</p>
</div>
<div class="paragraph">
<p>See <a href="https://castle-engine.sourceforge.io/macosx_requirements.php" class="bare">https://castle-engine.sourceforge.io/macosx_requirements.php</a> for more information about developing desktop applications for macOS using Castle Game Engine.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installing_fpc_cross_compilers_for_iphone_and_iphonesimulator">3. Installing FPC cross-compilers for iPhone and iPhoneSimulator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You will need to have FPC cross-compilers able to create these OS/CPU combinations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>iphonesim/i386</code> and <code>iphonesim/x86_64</code> applications (for the iPhone simulator)</p>
</li>
<li>
<p><code>darwin/arm</code> and <code>darwin/aarch64</code> applications (for the actual iPhone device). Note: <code>aarch64</code> is also called <code>arm64</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s easiest to get them from the FPC:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Go to <a href="https://sourceforge.net/projects/freepascal/files/Mac%20OS%20X/" class="bare">https://sourceforge.net/projects/freepascal/files/Mac%20OS%20X/</a></p>
</li>
<li>
<p>Select latest stable version (like <code>3.2.0</code> at the time of writing this)</p>
</li>
<li>
<p>Download the cross-compiler for iOS from there, <code>xxx-macosx.cross.ios.dmg</code> from there (like <code>fpc-3.2.0.intel-macosx.cross.ios.dmg</code> at the time of writing this). Install this.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Old note for FPC 3.0.4/3.0.5</strong>: <code>fpc-3.0.5.intel-macosx.cross.ios.dmg</code> seems to have problems with the latest XCode versions, that don&#8217;t create <code>/usr/lib/crt1.o</code>. This file is required to finish the installation (and later to compile libraries), by <a href="https://svn.freepascal.org/cgi-bin/viewvc.cgi/trunk/install/macosx/packaging/packages/fpc-3.0.4.intel-macosx.pkgproj?view=co&amp;revision=1379&amp;root=fpcbuild" class="bare">https://svn.freepascal.org/cgi-bin/viewvc.cgi/trunk/install/macosx/packaging/packages/fpc-3.0.4.intel-macosx.pkgproj?view=co&amp;revision=1379&amp;root=fpcbuild</a> , otherwise the installer thinks that "XCode command-line tools" are not present. The workaround:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check whether you have <a href="https://support.apple.com/en-gb/HT204899">SIP (System Integrity Protection)</a> enabled using <code>csrutil status</code>.</p>
</li>
<li>
<p>If SIP is enabled, fix it by running these commands as <code>root</code> in the terminal:</p>
<div class="listingblock">
<div class="content">
<pre> # boot into recovery terminal
 csrutil disable
 reboot

 # Boot into recovery terminal
 # The &lt;Mac&gt; part of the path below varies depending on your Mac
 cd /Volumes/&lt;Mac&gt;/usr/lib/
 cp ../../Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/lib/*.o .
 csrutil enable
 reboot</pre>
</div>
</div>
</li>
<li>
<p>If SIP is disabled, it&#8217;s simpler:</p>
<div class="listingblock">
<div class="content">
<pre> sudo ln -s /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib/crt1.o /usr/lib/
 sudo ln -s /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib/dylib1.o /usr/lib/</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>With FPC 3.2.0, the problems are gone.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_fpc_cross_compilers">4. Testing FPC cross-compilers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before attempting the compilation of a full program, we advise testing that your <code>fpc</code> is installed OK and supports the necessary platforms.</p>
</div>
<div class="paragraph">
<p><em>First, test that you can compile for the necessary CPUs</em>. The cross-compiler for each CPU is actually a different FPC executable, so the lines below will make an error immediately if you cannot cross-compile to the given CPU. The desired result is that they should answer <em>No source file name in command line</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>fpc -Pi386    -l # old note: maybe add -V3.0.5, if you use FPC 3.0.4/3.0.5 combination
fpc -Px86_64  -l # old note: maybe add -V3.0.5, if you use FPC 3.0.4/3.0.5 combination
fpc -Parm     -l
fpc -Paarch64 -l</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Add <code>-V3.0.5</code> to the lines marked above, if you use the official "FPC for iOS" installed from <code>fpc-3.0.5.intel-macosx.cross.ios.dmg</code> file. See the <code>Getting Started - iOS.rtf</code> file inside for explanation. This is no longer needed for FPC 3.2.0.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>Second, test the actual compilation.</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>cd /tmp/
echo 'library test_compilation; begin end.' &gt; test_compilation.lpr

SIMULATOR_SDK='/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk'
fpc -Pi386    -Tiphonesim -WP7.0 -XR${SIMULATOR_SDK} test_compilation.lpr # old note: maybe add -V3.0.5, if you use FPC 3.0.4/3.0.5 combination
fpc -Px86_64  -Tiphonesim -WP7.0 -XR${SIMULATOR_SDK} test_compilation.lpr # old note: maybe add -V3.0.5, if you use FPC 3.0.4/3.0.5 combination

DEVICE_SDK='/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk'
# Use below -TiOS instead of -Tdarwin with FPC &gt;= 3.2.2.
fpc -Parm     -Tdarwin    -WP7.0 -Cfvfpv3 -Cparmv7 -XR${DEVICE_SDK} test_compilation.lpr
fpc -Paarch64 -Tdarwin    -WP7.0                   -XR${DEVICE_SDK} test_compilation.lpr</pre>
</div>
</div>
<div class="paragraph">
<p>Note that in FPC 3.2.2 the iOS targets should be called with <code>-TiOS</code>, not <code>-Tdarwin</code>. See <a href="https://wiki.freepascal.org/FPC_New_Features_3.2.2#Support_for_macOS.2FAArch64">FPC 3.2.2 new features</a>, <a href="https://wiki.freepascal.org/User_Changes_3.2.2#The_Darwin_targets_corresponding_to_iOS_have_been_renamed_to_iOS">FPC 3.2.2 user changes</a>.</p>
</div>
<div class="paragraph">
<p>Every <code>fpc</code> invocation should create <code>libtest_compilation.dylib</code>.</p>
</div>
<div class="paragraph">
<p>The reasons behind some of these compiler options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We test by compiling a library, not a program. Compiling a program fails at linking:</p>
<div class="ulist">
<ul>
<li>
<p>iphonesim/i386 error: Undefined symbols for architecture i386: "___keymgr_dwarf2_register_sections", referenced from:</p>
</li>
<li>
<p>iphonesim/x86<em>64 error: Undefined symbols for architecture x86_64: "</em>__keymgr_dwarf2_register_sections"</p>
</li>
<li>
<p>darwin/arm error: Undefined symbols for architecture armv7: "start"</p>
</li>
</ul>
</div>
</li>
<li>
<p>We use -WP5.1, otherwise the <code>darwin/arm</code> fails at linking (error: <em>symbol dyld_stub_binding_helper not found, normally in crt1.o/dylib1.o/bundle1.o for architecture armv7</em>).</p>
</li>
<li>
<p>Actually we use later <code>-WP7.0</code>, corresponding to what CGE uses now.</p>
</li>
<li>
<p>The additional parameters (the -XRxxx, and -Cfvfpv3 -Cparmv7) come from the <code>Getting Started - iOS.rtf</code> file from the FPC for iOS package.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_iphone_simulator_is_not_an_iphone_emulator">5. iPhone Simulator is not an iPhone emulator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>iPhone Simulator</em> is <em>not</em> an emulator of a real iPhone device, i.e. it does not emulate the processor (like ARM) inside the iPhone. Rather, it&#8217;s a modified version of the normal (desktop) macOS system, running on a normal (i386 or x86_64) CPU.</p>
</div>
<div class="paragraph">
<p>See "iPhone Simulator is not iPhone" on <a href="http://wiki.freepascal.org/iPhone/iPod_development" class="bare">http://wiki.freepascal.org/iPhone/iPod_development</a> for more information.</p>
</div>
<div class="paragraph">
<p>This should help you understand why we did some things above, e.g. why do we have a special compilation target for <em>iPhone Simulator</em> (because we cannot just run in the simular the application compiled for an actual iPhone), and why it works fast (because it doesn&#8217;t emulate the iPhone CPU).</p>
</div>
<div class="paragraph">
<p>This is in contrast to the Android emulator.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_the_build_tool">6. Using the build tool</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure the <a href="build tool">build tool</a> is available on $PATH, so you can call <code>castle-engine</code> in the terminal.</p>
</li>
<li>
<p>Run in terminal:</p>
<div class="listingblock">
<div class="content">
<pre> cd &lt;castle-engine&gt;/examples/2d_dragon_spine_game/
 castle-engine package --target=ios</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Tip: You can speedup this process</strong>: The <code>package</code> command by default cleans and recompiles everything, to make sure everything is recompiled for the current mode (which is a <em>release mode</em> by default). When developing, it&#8217;s often useful to make this process quicker, and recompile only what changed. Do this by adding <code>--fast</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> cd &lt;castle-engine&gt;/examples/2d_dragon_spine_game/
 castle-engine package --target=ios --fast</pre>
</div>
</div>
<div class="paragraph">
<p>Another way to speedup the process is to rebuild <em>only code</em>. Add the <code>--update-only-code</code> option for this.</p>
</div>
<div class="paragraph">
<p><strong>Tip: You can include iOS simulator support</strong>: Simply add the <code>--ios-simulator</code> command-line option. By default this is off, as including simulator support makes build longer (2 more platforms to compile for) and often it is not necessary. Like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> cd &lt;castle-engine&gt;/examples/2d_dragon_spine_game/
 castle-engine package --target=ios --ios-simulator</pre>
</div>
</div>
</li>
<li>
<p>Run <em>Xcode</em> and open the resulting project in <code>&lt;castle-engine&gt;/examples/2d_dragon_spine_game/castle-engine-output/ios/xcode_project/</code>.</p>
<div class="paragraph">
<p>Open the file with <code>.xcworkspace</code> extension in that directory. For now, all iOS projects use <a href="https://github.com/castle-engine/castle-engine/wiki/iOS-Services#common-notes-for-services-using-cocoapods">CocoaPods</a> and so you need to open them through the <code>.xcworkspace</code> file, not just <code>.xcodeproj</code>.</p>
</div>
</li>
<li>
<p>Run the project from Xcode (<em>Command + R</em>), to see your game working in an <em>iPhone simulator</em>.</p>
<div class="paragraph">
<p><strong>Tip: Running on a real, physical device:</strong> It works out of the box! You only need to set the <em>Development Team</em> in Xcode, or set <code>&lt;ios team="xxx" /&gt;</code> attribute in <a href="CastleEngineManifest.xml examples">CastleEngineManifest.xml</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://castle-engine.sourceforge.io/images/original_size/xcode_select_team.png"><img src="https://castle-engine.sourceforge.io/images/thumb_size/xcode_select_team.png" alt="Selecting a team in Xcode"></a>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_archive_deploy_on_ios">7. Archive (deploy on iOS)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can perform further automatic packaging using the command-line CGE <a href="Build Tool" class="bare">Build Tool</a>. Call this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>castle-engine package --target=iOS --package-format=ios-archive-ad-hoc</pre>
</div>
</div>
<div class="paragraph">
<p>This generates an IPA file which you can distribute to your testers e.g. using <a href="https://github.com/castle-engine/castle-engine/blob/master/tools/build-tool/data/ios/services/test_fairy/README.md">TestFairy</a>. The resulting IPA file will be inside the <code>castle-engine-output/ios/build/</code> subdirectory. It is somewhat similar to Android APK, although distributing IPA to testers is more cumbersome (their devices need to be registered in your Apple developer account, and Xcode must know them at build-time to sign IPA for them).</p>
</div>
<div class="paragraph">
<p>Other options are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ios-archive-development</code></p>
</li>
<li>
<p><code>ios-archive-app-store</code>. Note that this <em>does not</em> upload to the AppStore (although we&#8217;d like to extend this someday to do it, but it&#8217;s unsure whether it is actually possible). In effect this is not very useful in practice, and you <em>do not</em> need to use this to release your iOS application on the TestFlight / AppStore.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that these options automatically sign the application. To make it work,</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Register as a (paid) Apple Developer,</p>
</li>
<li>
<p>Place your "team ID" in the iOS section of the <a href="CastleEngineManifest.xml-examples">CastleEngineManifest.xml</a>,</p>
</li>
<li>
<p>Release from Xcode <em>once</em> manually. Xcode will ask you to configure your team, store the team password in your keychain etc. Once it works, next time you can do it all automatically.</p>
</li>
<li>
<p>If you do it through SSH (not in an interactive GUI session) you need to call</p>
<div class="listingblock">
<div class="content">
<pre> security unlock-keychain login.keychain</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre> security unlock-keychain -p YOUR-PASSWORD login.keychain</pre>
</div>
</div>
<div class="paragraph">
<p>to unlock the keychain before building.</p>
</div>
</li>
<li>
<p>And now <code>castle-engine package --target=iOS --package-format=ios-archive-...</code> will work smoothly.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upload_to_testflight_and_appstore">8. Upload to TestFlight and AppStore</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To upload the application to the AppStore:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create and configure your iOS application on <a href="https://appstoreconnect.apple.com/" class="bare">https://appstoreconnect.apple.com/</a> . You will link there the uploaded build number later.</p>
</li>
<li>
<p>Package project for iOS (any <code>--package-format=</code>, including default <code>--package-format=ios-xcode-project</code>, is OK).</p>
</li>
<li>
<p>Open resulting project in <code>castle-engine-output/ios/</code> in Xcode. Switch target to <em>"Any device"</em>, press <em>"Archive"</em>. In the resulting window (once archive is done) press <em>"Distribute"</em> selecting the option to upload to the store.</p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_debugging_the_pascal_code_without_ios" class="sect0">Debugging the Pascal Code without iOS</h1>
<div class="openblock partintro">
<div class="content">
Same instructions as for <a href="https://github.com/castle-engine/castle-engine/wiki/Android-FAQ#testing-mobile-opengl-es-rendering-without-an-android">Testing mobile (OpenGL ES) rendering without an Android</a> apply here too, as the Pascal code is platform independent.
</div>
</div>
<h1 id="_known_problems" class="sect0">Known problems</h1>
<div class="openblock partintro">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>When compiling with FPC 3.2.2, there are a lot of warnings</p>
<div class="listingblock">
<div class="content">
<pre>  clang: warning: using sysroot for 'MacOSX' but targeting 'iPhone' [-Wincompatible-sysroot]</pre>
</div>
</div>
<div class="paragraph">
<p>They can be ignored. We link with proper iOS libraries, don&#8217;t worry. We don&#8217;t yet know how to avoid this warning.</p>
</div>
</li>
<li>
<p>The event loop on iOS must be controlled by the main program in Objective-C, not in Pascal. This means that <code>Application.ProcessMessages</code> does not work. The library cannot force the main process to handle some events, and wait for something to happen. This means that you cannot use <code>Application.ProcessMessages</code>, or things depending on them:</p>
<div class="ulist">
<ul>
<li>
<p><code>CastleMessages</code> (functions in this unit make modal windows, running a message loop inside and only returning when user exits&#8201;&#8212;&#8201;similar to <code>ShowMessage</code> in Lazarus LCL / Delphi VCL),</p>
</li>
<li>
<p><code>CastleWindowProgress</code> (it processes messages to redraw the screen inside <code>Progress.Step</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To make modal windows on iOS, use <a href="https://michalis.ii.uni.wroc.pl/cge-www-preview/apidoc/html/CastleDialogStates.html">CastleDialogStates</a> unit with modal windows using <code>TUIState</code> class. You can also set <a href="https://michalis.ii.uni.wroc.pl/cge-www-preview/apidoc/html/CastleMessages.html#MessageOKPushesState">MessageOKPushesState</a> to <code>true</code>. To show progress bar, use <code>TCastleProgressBar</code> control, which you will need to continuously update yourself, for example in your <code>Window.OnUpdate</code> event.</p>
</div>
</li>
<li>
<p>On iOS, the OpenGL(ES) context is created and destroyed solely by the Objective-C code, not Pascal. You cannot use the <code>Window.Open</code> and <code>Window.Close</code> from the Pascal code to force recreating OpenGL context. This follows our <a href="https://castle-engine.io/manual_cross_platform.php">cross-platform code guidelines</a>.</p>
</li>
<li>
<p>The <a href="https://developer.apple.com/documentation/uikit/uiresponder/1621084-touchesended?language=objc">touchesEnded</a> / <a href="https://developer.apple.com/documentation/uikit/uiresponder/1621116-touchescancelled?language=objc">touchesCancelled</a> events on iOS (that in turn determine CGE events like <code>TUIState.Release</code>, <code>TCastleWindowBase.OnRelease</code>) have poor behavior.</p>
<div class="paragraph">
<p>It seems to be implemented like <em>"report that touch ends, or is cancelled, when the finger position doesn&#8217;t change for the 0.36 seconds"</em>. It seems to be done regardless of <strong>when</strong> did the user actually released the finger, and <strong>if</strong> the user actually released the finger. You can test this unfortunate behavior even with simple CGE example <code>examples/user_interface/test_all_state_events/</code> . As a result:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you press and release the finger, you will notice that CGE <code>Release</code> event is reported with small (0.36 sec) delay instead of being instant. This small delay sometimes matters in games&#8201;&#8212;&#8201;you will e.g. see <code>buttonLeft in Container.MousePressed</code> for a short time, even after user physically released the finger.</p>
</li>
<li>
<p>If you keep pressing your finger, but without any movement, then the CGE <code>Release</code> event will be reported (and the touch will no longer be tracked). Even if you keep holding the finger down.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There&#8217;s no reliable solution, it seems to be just the way iOS behaves. Trying various, even crazy, things (like not calling <code>super</code> in <code>touchXxx</code> events, or <code>touchesCancelled</code>) in <code>OpenGLController.m</code> code doesn&#8217;t help. Your application simply must be ready for this iOS weirdness&#8201;&#8212;&#8201;the CGE <code>Release</code> event may happen too early, or too soon, in case user presses the screen quickly, or presses and holds without moving.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_more_information_about_fpc_and_ios" class="sect0">More information about FPC and iOS</h1>
<div class="openblock partintro">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><a href="http://wiki.freepascal.org/iPhone/iPod_development" class="bare">http://wiki.freepascal.org/iPhone/iPod_development</a></p>
</li>
<li>
<p><a href="http://wiki.lazarus.freepascal.org/Portal:iOS" class="bare">http://wiki.lazarus.freepascal.org/Portal:iOS</a></p>
</li>
<li>
<p>Building FPC and cross-compiling: <a href="http://www.stack.nl/~marcov/buildfaq/" class="bare">http://www.stack.nl/~marcov/buildfaq/</a></p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_alternative_using_fpc_trunk_unstable" class="sect0">Alternative: Using FPC trunk (unstable)</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Instead of using the stable FPC, you can try using the latest FPC trunk version (3.3.1 now). You need to install 4 cross-compilers, for all 4 platforms that are included in the <em>"iOS target"</em>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>arm / darwin <code># use iOS instead of darwin with FPC &gt;= 3.2.2</code></p>
</li>
<li>
<p>aarch64 / darwin <code># use iOS instead of darwin with FPC &gt;= 3.2.2</code></p>
</li>
<li>
<p>iPhoneSimulator / i386</p>
</li>
<li>
<p>iPhoneSimulator / x86_64</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>An easy way to install cross-compilers is to use <a href="fpcupdeluxe">fpcupdeluxe</a>. Notes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>iPhoneSimulator is called <em>i-sim</em> in the fpcupdeluxe UI.</p>
</li>
<li>
<p>Our build tool uses the <code>fpc</code> binary available on your <code>$PATH</code> environment variable. Make sure you create an appropriate symlink to make it call the FPC installed by <a href="fpcupdeluxe">fpcupdeluxe (this wiki page describes this)</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you compiled your own FPC version, you will want to use <code>--fpc-version-iphone-simulator ""</code> on the command-line to the build tool. Otherwise the build tool may try to call FPC for iPhone Simulator target with a different FPC version (because the standard FPC 3.0.4 / 3.0.5 mix requires this). So you will usually call this in your project:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ fpc -v
Free Pascal Compiler version 3.0.4 [2017/11/26] for i386
...
$ castle-engine package --target=ios --fpc-version-iphone-simulator "" --fast
...
Compiling project "drawing_toy" for target "ios" in mode "release".
FPC version: 3.1.1
FPC executing...
Compiling Release Version
...
Target OS: Darwin/iPhoneSim for i386
...
Target OS: Darwin/iPhoneSim for x86_64
...
Target OS: Darwin for ARM
...
Target OS: Darwin for AArch64</pre>
</div>
</div>
</div>
</div>