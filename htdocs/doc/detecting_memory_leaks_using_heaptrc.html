<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_intro">1. Intro</a></li>
<li><a href="#_using_heaptrc_in_castle_game_engine">2. Using HeapTrc in Castle Game Engine</a></li>
<li><a href="#_interpreting_the_results">3. Interpreting the results</a></li>
<li><a href="#_caveat_ignore_output_when_halt_occurred">4. Caveat: Ignore output when <code>Halt</code> occurred</a></li>
<li><a href="#_caveat_windows_gui_output_is_bothersome">5. Caveat: Windows GUI output is bothersome</a></li>
<li><a href="#_advanced_routing_heaptrc_output_to_a_file">6. Advanced: Routing HeapTrc output to a file</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Table of Contents:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#intro">Intro</a></p>
</li>
<li>
<p><a href="#using-heaptrc-in-castle-game-engine">Using HeapTrc in Castle Game Engine</a></p>
</li>
<li>
<p><a href="#interpreting-the-results">Interpreting the results</a></p>
</li>
<li>
<p><a href="#caveat-ignore-output-when-halt-occurred">Caveat: Ignore output when Halt occurred</a></p>
</li>
<li>
<p><a href="#caveat-windows-gui-output-is-bothersome">Caveat: Windows GUI output is bothersome</a></p>
</li>
<li>
<p><a href="#advanced-routing-heaptrc-output-to-a-file">Advanced: Routing HeapTrc output to a file</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_intro">1. Intro</h2>
<div class="sectionbody">
<div class="paragraph">
<p>"Memory leak" means that you allocated a memory for something, but didn&#8217;t deallocate it.</p>
</div>
<div class="paragraph">
<p>For example you created an instance of a class by <code>MyInstance := TObject.Create</code> but then forgot to call <code>FreAndNil(MyInstance)</code>. See <a href="https://castle-engine.io/modern_pascal_introduction.html#_freeing_classes">the chapter about freeing classes in Pascal</a>. While Pascal offers various helpers to make it easy to deal with (e.g. <code>TComponent</code> can own other <code>TComponent</code> instances, freeing them automatically) but in general Pascal remains a language where you have to manually free all your allocated memory.</p>
</div>
<div class="paragraph">
<p>While not all memory leaks result in severe consequences, they usually indicate unsafe code organization and may be result of more extensive bugs. Therefore it is highly recommended to keep the code clean of memory leaks. This is where a very useful Free Pascal unit <a href="https://www.freepascal.org/docs-html/rtl/heaptrc/index.html">HeapTrc</a> can help by enabling developers to debug run-time memory allocation and deallocation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_heaptrc_in_castle_game_engine">2. Using HeapTrc in Castle Game Engine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using HeapTrc with <em>Castle Game Engine</em> is the same as with any other FPC application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use compiler switches <code>-gl -gh</code> or (combined into one option) <code>-glh</code>.</p>
</li>
<li>
<p><code>-gh</code> means that <code>HeapTrc</code> is used, <code>-gl</code> means that line information is visible (very useful to see <em>where</em> was the memory leak, i.e. which allocation was not followed by deallocation).</p>
</li>
<li>
<p>NOTE: <em>do not</em> include HeapTrc in the <code>uses</code> section explicitly. The <code>-gh</code> will automatically use the <code>HeapTrc</code> unit correctly.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are various ways to pass these options to FPC:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you use the <a href="https://github.com/castle-engine/castle-engine/wiki/Build-Tool">build tool</a>, you can call it like <code>castle-engine --compiler-option=-glh compile</code> to compile.</p>
</li>
<li>
<p>Alternatively, you can add them to <a href="https://github.com/castle-engine/castle-engine/wiki/CastleEngineManifest.xml-examples#compiler-options-and-paths">compiler options in CastleEngineManifest.xml</a>.</p>
</li>
<li>
<p>Alternatively, you can use them for <em>all</em> your programs by adding to <a href="https://www.freepascal.org/docs-html/user/usersu10.html">fpc.cfg</a> file. You can add them only to the <code>DEBUG</code> builds (done by <code>castle-engine --mode-debug compile</code>) like this:</p>
<div class="listingblock">
<div class="content">
<pre>  #IFDEF DEBUG
  -gh
  -gl
  #ENDIF</pre>
</div>
</div>
</li>
<li>
<p>If you compile using Lazarus: Note that <code>HeapTrc</code> is enabled by default in Lazarus <em>Debug</em> mode, which can be created and set in Project Options.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, <code>HeapTrc</code> will monitor all memory allocation and deallocation events during the program execution and will provide a thorough report after the execution stops in a regular way or due to an exception, unless the application process was killed by OS.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_interpreting_the_results">3. Interpreting the results</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In effect, at the program&#8217;s exit, you will get a useful report about the allocated and not freed memory blocks (i.e. <em>memory leaks</em>). Each leak will have a stack trace to the allocation call. This allows to easily detect and fix memory leaks.</p>
</div>
<div class="paragraph">
<p>If everything is OK, the output looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Heap dump by heaptrc unit
12161 memory blocks allocated : 2290438/2327696
12161 memory blocks freed     : 2290438/2327696
0 unfreed memory blocks : 0
True heap size : 1212416
True free heap : 1212416</pre>
</div>
</div>
<div class="paragraph">
<p>But when you have a memory leak, it tells you about it, and tells you where the relevant memory was allocated, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Heap dump by heaptrc unit
4150 memory blocks allocated : 1114698/1119344
4099 memory blocks freed     : 1105240/1109808
51 unfreed memory blocks : 9458
True heap size : 851968
True free heap : 834400
Should be : 835904
Call trace for block $00007F9B14E42980 size 44
  $0000000000402A83 line 162 of xxx.lpr
  ...</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_caveat_ignore_output_when_halt_occurred">4. Caveat: Ignore output when <code>Halt</code> occurred</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you exit with <code>Halt</code>, ou will always have some memory leaks, that&#8217;s unavoidable right now. You should ignore the "<em>Heap dump by heaptrc unit</em>" output in this case.</p>
</div>
<div class="paragraph">
<p>Same thing applies when your program crashes with an unhandled exception.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_caveat_windows_gui_output_is_bothersome">5. Caveat: Windows GUI output is bothersome</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The behavior in case of memory leaks on Windows GUI application is unfriendly. Memory leaks are displayed using a series of Windows modal message boxes, and you have to click through them, or kill the application.</p>
</div>
<div class="paragraph">
<p>It&#8217;s better to switch application to <code>CONSOLE`</code> for debugging, and run it from command-line, to observe HeapTrc output.</p>
</div>
<div class="paragraph">
<p>Or use the advise below to redirect the output to file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_routing_heaptrc_output_to_a_file">6. Advanced: Routing HeapTrc output to a file</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, <code>HeapTrc</code> output is dumped into standard output (on *Nix systems and on console Windows applications). However, for Windows GUI applications, the <code>HeapTrc</code> output is shown as a series of modal popup windows and can be very tedious to work with in case the output is extensive.</p>
</div>
<div class="paragraph">
<p>This behavior can be changed by explicitly requesting to dump <code>HeapTrc</code> output to a file by using <a href="https://www.freepascal.org/docs-html/rtl/heaptrc/setheaptraceoutput.html">SetHeapTraceOutput</a> procedure. E.g. add <code>SetHeapTraceOutput(URLToFilenameSafe(ApplicationConfig('heaptrc.log')));</code> in main project source file.</p>
</div>
<div class="paragraph">
<p>Note, that as this way the <code>HeapTrc</code> would not be shown explicitly after the program exits, the developer has to remember to analyze this file manually to check if there are any memory leaks.</p>
</div>
</div>
</div>