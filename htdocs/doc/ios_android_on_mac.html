<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a></li>
<li><a href="#_compile_android_cross_compiler">2. Compile Android cross compiler</a></li>
<li><a href="#_install_fpc_3_0_4">3. Install FPC 3.0.4</a></li>
<li><a href="#_put_compilers_together">4. Put compilers together</a></li>
<li><a href="#_add_android_ndk_paths_to_fpc_cfg">5. Add Android NDK paths to fpc.cfg</a></li>
<li><a href="#_running_the_build_tool">6. Running the Build Tool</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can read how the set the environment for deploying to <a href="Android" class="bare">Android</a>, and for deploying to <a href="iOS" class="bare">iOS</a> devices on separate pages. This page describes the process when you want to use a single Mac computer to do both.</p>
</div>
<div class="paragraph">
<p><strong>Note: This document was not updated since FPC 3.0.4. Some steps may be easier now with later FPC, and definitely things are easier with <a href="fpcupdeluxe" class="bare">fpcupdeluxe</a>. We hope that this information is useful, but you should not follow it literally.</strong></p>
</div>
<div class="paragraph">
<p>The main problem comes from the current state of the stable FPC release, when there are official FPC packages for macOS development (version 3.0.4) and cross compiler to iOS (version 3.0.5). And you have to manually compile the cross compiler for Android using FPC version 3.0.0.</p>
</div>
<div class="paragraph">
<p>We hope this process will simplify a lot after FPC releases a new stable version (3.1.1?). You can also use <a href="fpcupdeluxe" class="bare">fpcupdeluxe</a> that does everything for you.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compile_android_cross_compiler">2. Compile Android cross compiler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cross compiler is not distributed as an official package, so you need to compile it yourself. And you need FPC 3.0.0 for this (i.e. not 3.0.4) together with FPC sources for version 3.0.4.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download and install <a href="https://sourceforge.net/projects/freepascal/files/Mac%20OS%20X/3.0.0/">FPC 3.0.0 for macOS</a>
<code>fpc-3.0.0.intel-macosx.dmg</code></p>
</li>
<li>
<p>Download and install <a href="https://sourceforge.net/projects/lazarus/files/Lazarus%20Mac%20OS%20X%20i386/Lazarus%201.8.0/">FPC 3.0.4 sources</a>
<code>fpc-src-3.0.4-macosx.dmg</code>. You have to do this step when you want to run Lazarus on your computer anyway, so I recommend to download the sources from the official Lazarus distribution.</p>
</li>
<li>
<p>Install Android Studio with <em>"Android 6.0 (Marshmallow) - API 23"</em>, <em>"Android SDK Build-tools"</em> version 23.0.2 and NDK as described on our <a href="Android" class="bare">Android</a> page.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Before compiling the cross compiler, you need to add Android binutils to your $PATH. If you also plan to use our <a href="Build Tool" class="bare">Build Tool</a>, your <code>~/.bash_profile</code> should look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>export PATH="$HOME/MyProjects/castle-engine/tools/build-tool:$HOME/Library/Android/sdk/platform-tools:$HOME/Library/Android/sdk/ndk-bundle/toolchains/arm-linux-androideabi-4.9/prebuilt/darwin-x86_64/bin:$PATH"
export CASTLE_ENGINE_PATH=$HOME/MyProjects/castle-engine/
export ANDROID_HOME=$HOME/Library/Android/sdk
export ANDROID_NDK_HOME=$HOME/Library/Android/sdk/ndk-bundle</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create the cross compiler as described on our <a href="Android#fpc-for-android">Android</a> page or <a href="http://wiki.freepascal.org/Android">Lazarus wiki</a>. If you used the above packages and installed them to their default locations, following two lines should do it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cd /usr/local/share/fpcsrc
sudo make clean crossall crossinstall OS_TARGET=android CPU_TARGET=arm CROSSOPT="-Cfvfpv3" INSTALL_PREFIX=$HOME/fpc_android</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_install_fpc_3_0_4">3. Install FPC 3.0.4</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download and install <a href="https://sourceforge.net/projects/freepascal/files/Mac%20OS%20X/3.0.4/">FPC 3.0.4 for macOS</a>
<code>fpc-3.0.4.intel-macosx.dmg</code></p>
</li>
<li>
<p>Download and install <a href="https://sourceforge.net/projects/freepascal/files/Mac%20OS%20X/3.0.4/">FPC 3.0.5 cross iOS for macOS</a>
<code>fpc-3.0.5.intel-macosx.cross.ios.dmg</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can also install <a href="https://sourceforge.net/projects/lazarus/files/Lazarus%20Mac%20OS%20X%20i386/Lazarus%201.8.0/">Lazarus</a> at this moment.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_put_compilers_together">4. Put compilers together</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Right now, you can compile to iOS without problems, we just need to "install" our compiled Android cross compiler.</p>
</div>
<div class="paragraph">
<p>Navigate to <code>/usr/local/lib/fpc</code>. The official packages install there, so you should find the following directory structure there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>3.0.0   (not interesting for us anymore, can be deleted later)
3.0.4   (main 3.0.4 compiler with units for i386 and x86_64)
  +-- units/
        +-- i386-darwin/
        +-- x86_64-darwin/
  +-- fpmkinst/  (same structure as units/)
  +-- ppc386, ppcx64
3.0.5   (special version for compiling to iOS)
  +-- units/
        +-- aarch64-darwin/
        +-- arm-darwin/
        +-- i386-iphonesim/
        +-- x86_64-iphonesim/
  +-- fpmkinst/  (same structure as units/)
  +-- ppc386, ppcx64, ppcarm, ppca64</pre>
</div>
</div>
<div class="paragraph">
<p>To have everything organised, I recommend to copy our Android cross compiler into this structure, under 3.0.4 directory.</p>
</div>
<div class="paragraph">
<p>Navigate to <code>~/fpc_android/lib/fpc/3.0.4</code> and copy all contents to <code>/usr/local/lib/fpc/3.0.4</code>. It means:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>copy <code>~/fpc_android/lib/fpc/3.0.4/fpmkinst/arm-android</code> to <code>/usr/local/lib/fpc/3.0.4/fpmkinst/</code></p>
</li>
<li>
<p>copy <code>~/fpc_android/lib/fpc/3.0.4/units/arm-android</code> to <code>/usr/local/lib/fpc/3.0.4/units/</code></p>
</li>
<li>
<p>copy <code>~/fpc_android/lib/fpc/3.0.4/ppcrossarm</code> to <code>/usr/local/lib/fpc/3.0.4/</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Unfortunately, it&#8217;s not enough. When running <code>fpc -Parm</code> command to run ARM compiler, FPC automatically uses the ppcarm version for iOS under version 3.0.5. Let&#8217;s prepare the link to run our ARM compiler too.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cd /usr/local/bin
sudo ln -s ../lib/fpc/3.0.4/ppcrossarm ppcarm-3.0.4</pre>
</div>
</div>
<div class="paragraph">
<p>To verify, you can run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls -l /usr/local/bin/ppc*
lrwxr-xr-x  1 root  (...) /usr/local/bin/ppc386 -&gt; ../lib/fpc/3.0.4/ppc386
lrwxr-xr-x  1 root  (...) /usr/local/bin/ppc386-3.0.5 -&gt; ../lib/fpc/3.0.5/ppc386
lrwxr-xr-x  1 root  (...) /usr/local/bin/ppca64 -&gt; ../lib/fpc/3.0.5/ppca64
lrwxr-xr-x  1 root  (...) /usr/local/bin/ppcarm -&gt; ../lib/fpc/3.0.5/ppcarm
lrwxr-xr-x  1 root  (...) /usr/local/bin/ppcarm-3.0.4 -&gt; ../lib/fpc/3.0.4/ppcrossarm
lrwxr-xr-x  1 root  (...) /usr/local/bin/ppcx64 -&gt; ../lib/fpc/3.0.4/ppcx64
lrwxr-xr-x  1 root  (...) /usr/local/bin/ppcx64-3.0.5 -&gt; ../lib/fpc/3.0.5/ppcx64</pre>
</div>
</div>
<div class="paragraph">
<p>Another solution would be to unlink ppcarm from version 3.0.5 and link it to our Android compiler, but I decided not to touch the official distribution.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_android_ndk_paths_to_fpc_cfg">5. Add Android NDK paths to fpc.cfg</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last configuration step is to add the path to Android NDK libraries to your fpc.cfg. The default location of this file on macOS is <code>/etc/fpc.cfg</code>. I recommend to edit it and insert following lines, for example under the section with Xcode libraries <em>(-Fl/Applications/Xcode.app/&#8230;&#8203;)</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>#ifdef android
#ifdef cpuarm
-Fl/users/your_user_name/library/Android/sdk/ndk-bundle/platforms/android-23/arch-arm/usr/lib
#endif
#ifdef cpu386
-Fl/users/your_user_name/library/Android/sdk/ndk-bundle/platforms/android-23/arch-x86/usr/lib
#endif
#endif</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_the_build_tool">6. Running the Build Tool</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As we have this confusion about <code>ppcarm</code> version, we have to tell the <a href="Build Tool" class="bare">Build Tool</a> we need to use FPC version 3.0.4 when compiling to Android. Use the <code>--compiler-option</code> command line parameter. So, for example, the command line can be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># Android
castle-engine package --os=android --cpu=arm --compiler-option=-V3.0.4</pre>
</div>
</div>
<div class="paragraph">
<p>For iOS, nothing special is needed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># iOS
castle-engine package --target=ios</pre>
</div>
</div>
</div>
</div>