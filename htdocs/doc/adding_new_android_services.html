<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a></li>
<li><a href="#_be_sure_to_use_android_project_type_integrated_this_is_the_default_now">2. Be sure to use Android project_type "integrated" (this is the default now)</a></li>
<li><a href="#_adding_new_service">3. Adding new service</a></li>
<li><a href="#_java_code_of_a_service">4. Java code of a service</a></li>
<li><a href="#_communicate_with_java">5. Communicate with Java</a></li>
<li><a href="#_adding_a_service_with_dynamic_library_so">6. Adding a service with dynamic library (SO)</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Castle Game Engine</em> defines a number of useful <a href="Android Services" class="bare">Android Services</a> and <a href="iOS Services" class="bare">iOS Services</a> to integrate with various 3rd-party libraries, SDKs to provide additional functionality to your application.</p>
</div>
<div class="paragraph">
<p>This page documents how you can add new services for Android.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_be_sure_to_use_android_project_type_integrated_this_is_the_default_now">2. Be sure to use Android project_type "integrated" (this is the default now)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All the Android services require that you have an <code>integrated</code> Android project type (default now), not <code>base</code>. With the <code>integrated</code> project type, our final Android project has it&#8217;s own activity class (<code>MainActivity</code>, descendant of <code>NativeActivity</code>, in <code>tools/build-tool/data/android/integrated/app/src/main/java/net/sourceforge/castleengine/MainActivity.java</code>), and it has Java code that is "summed" by adding all the files from</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>tools/build-tool/data/android/integrated</code></p>
</li>
<li>
<p>and subdirectories of <code>tools/build-tool/data/android/integrated-services</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>base</code> project type (you can request it by <code>CastleEngineManifest.xml</code>) is <em>not</em> suitable to implement additional services.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This project type on Android (constructed from code in <code>tools/build-tool/data/android/base/</code> ) does not contain <em>any</em> Java code. It is possible thanks to using Android <code>NativeActivity</code> class. The activity type of our game can be simply declared as <code>NativeActivity</code> then, for Android build tools, and there&#8217;s no need to create our own Java activity class, or to write any Java code at all. This possibility was explicitly documented at the <code>NativeActivity</code> docs from Google.</p>
</li>
<li>
<p>This allows our application to render, update, listen for touch events, in general use all the NDK functionality (including standard Unix library, e.g. to open files, and some Android-specific things like logging). For some simple games this is enough.</p>
</li>
<li>
<p>But any integrations that require Java libraries are impossible to implement in this case. The NDK libraries only provide some basic functionality, they absolutely <em>do not</em> cover the functionality offered by the Java API on Android.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_new_service">3. Adding new service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s easy to add your own Android services, if you need to integrate with some Android library not covered by existing <a href="Android Services" class="bare">Android Services</a>. Create your service inside the <code>castle_game_engine/tools/build-tool/data/android/integrated-services/xxx/</code> directory. The files there are copied to the final Android project, expanding macros inside. Most of the files are simply copied (but avoiding overwriting), but some files are merged in a special way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AndroidManifest.xml</code> of each service is merged with the main <code>AndroidManifest.xml</code> in a smart way, only adding the new permissions and new elements/attributes inside the <application>.</application></p>
</li>
<li>
<p><code>build.gradle</code> files inside the services have a special XML syntax. See the example services like <code>helpshift</code>. They are merged into the final (non-XML) <code>build.gradle</code> file in a smart way.</p>
</li>
<li>
<p>Each service may also insert a snippet of Java code to the <code>MainActivity.java</code> file. This is typically used to initialize the service-specific Java class, like</p>
<div class="listingblock">
<div class="content">
<pre>services.add(new ServiceStartApp(this));</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When developing new services, it&#8217;s useful to inspect the generated Android project in the <code>castle-engine-output/android/project</code>. This is created by the <a href="Build Tool" class="bare">Build Tool</a> by merging all the services with base project template. Look there after running <code>castle-engine package --target=android</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_java_code_of_a_service">4. Java code of a service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The main code of a service is usually a class descending from the <code>ServiceAbstract</code> class. It has some methods that you can override, like <code>onCreate</code>, <code>onStart</code>, and so on&#8201;&#8212;&#8201;they are called when the appropriate lifecycle event occurs on the <code>MainActivity</code>. The idea is that our <code>MainActivity</code> should be a relatively small class, that simply "passes on" the events to every service.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_communicate_with_java">5. Communicate with Java</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To communicate with the services from the Object Pascal code, use the <code>CastleMessaging</code> unit. Our units like <code>CastleAds</code> or <code>CastleGameService</code> are simply thin "wrappers" using <code>CastleMessaging</code> unit under the hood&#8201;&#8212;&#8201;see at their sources to know how it works, it is very straightfoward.</p>
</div>
<div class="paragraph">
<p>This way you can write Java code and utilize any Android Java API, and communicate with Pascal.</p>
</div>
<div class="paragraph">
<p>The <code>CastleMessaging</code> is a simple asynchronous communication mechanism between Pascal and Java, using it is easy (you have ready methods on both Pascal and Java side, and you don&#8217;t need to deal with JNI).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On the Pascal side, use <code>CastleMessaging</code> unit, with a singleton <code>Messaging</code> of class <code>TMessaging</code>. It has a simple <code>Send</code> method and allows to register <code>OnReceive</code> callbacks (like <code>Messaging.OnReceive.Add(@MessageReceived);</code>). Typically, you wrap sending and receiving messages in a nice Pascal API. Examples of it are in the CGE <code>src/services/</code> directory.</p>
</li>
<li>
<p>On the Java side, you create a class descending from <code>ServiceAbstract</code>. Such class can override <code>messageReceived</code> method to receive messages, and use <code>messageSend</code> to send messages. Examples of it are CGE services inside <code>tools/build-tool/data/android/integrated-services/XXX/src/net/sourceforge/castleengine/ServiceXXX.java</code> files.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See e.g. Google Play Games handling:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the Pascal part is in <code>src/services/castlegameservices.pas</code> ,</p>
</li>
<li>
<p>the Java part is in <code>tools/build-tool/data/android/integrated-services/google_play_games/src/net/sourceforge/castleengine/ServiceGooglePlayGames.java</code> .</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Java code of this particular service is no longer straightforward (it has a lot of functionality by now&#8230;&#8203;), but it shows how to pass messages back and forth.</p>
</div>
<div class="paragraph">
<p>For something simpler, see the "vibrate" service:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the Java side is in <code>build-tool/data/android/integrated-services/vibrate/</code> .</p>
</li>
<li>
<p>and the Pascal side is a trivial function <code>Vibrate</code> inside <code>src/services/castleopendocument.pas</code> .</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that <code>CastleMessaging</code> is not supposed to be an "API for all communication", but in practice it works very well in all existing services&#8201;&#8212;&#8201;since it&#8217;s natural for asynchronous processing (where many things are done in some thread, and/or wait for network or user input before returning any result).</p>
</div>
<div class="paragraph">
<p>The exact messages are not documented anywhere, since they are the "internal" API between Pascal and Java code. You should just cross-reference the <code>castlegameservices.pas</code> and <code>ServiceGooglePlayGames.java</code> and see that what one sends&#8201;&#8212;&#8201;the other receives:) When creating new service, you just invent your own messages, using any non-conflicting names.</p>
</div>
<div class="paragraph">
<p>In the Java part, you use the full power of Java APIs on Android, that are necessary to access various Android stuff. On the Pascal side, you create a thin wrappers that merely send/receive messages. Final games should use the Pascal API, without being aware of any "messages" underneath, e.g. see how <code>castle-engine/examples/2d_dragon_spine_android_game/</code> uses the <code>TGameService</code> class.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The disadvantage of <code>CastleMessaging</code> approach is that the communication between Java and Pascal looks like an asynchronous network channel. That&#8217;s OK in many cases (especially when the Java code indeed wraps some network operations), but it may be bad if you need to get something fast/synchronously. For such cases, using JNI to implement communication Java\&lt;&#8594;Pascal is necessary.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_a_service_with_dynamic_library_so">6. Adding a service with dynamic library (SO)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A service can be to add a dynamic library (SO, file like <code>libxxx.so</code>) to your Android project.</p>
</div>
<div class="paragraph">
<p>This should be compiled for all Android architectures, so you actually need 2 versions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Arm 32-bit (called just <code>arm</code> by various tools)</p>
</li>
<li>
<p>and Arm 64-bit (called <code>aarch64</code> by various tools).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In theory, only one of them can suffice, but then your application will only support one Android architecture. You would then build the application like * <code>castle-engine --cpu=arm --os=android</code> (to make 32-bit-only application)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>or <code>castle-engine --cpu=aarch64 --os=android</code> (to make 64-bit-only application).
For now, we strongly advise that you provide both SO versions, and compile your APK for both architectures using simple <code>castle-engine --target=android</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example services that includes SO files see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/castle-engine/castle-engine/tree/master/tools/build-tool/data/android/integrated-services/ogg_vorbis">ogg_vorbis</a></p>
</li>
<li>
<p><a href="https://github.com/castle-engine/castle-engine/tree/master/tools/build-tool/data/android/integrated-services/freetype">freetype</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>They contain just a few trivial files, and two SO files (for Arm 32-bit and 64-bit).</p>
</div>
</div>
</div>