<div class="paragraph">
<p>This page documents some compatibility-breaking changes in <em>Castle Game Engine</em> API version 6.5 (unstable) and 7.0 (upcoming stable release), compared to the last 6.4 release.</p>
</div>
<div class="paragraph">
<p>Note that <em>we try to do most of our changes without breaking compatibility, merely marking old API as "deprecated"</em>. This way you can keep using old API, and compiler nicely warns about it (although we advise to eventually upgrade "deprecated" stuff too, as "deprecated" stuff may be removed after a couple of more releases). The page below only lists changes that <em>had to be done by removing/changing something previously available</em>, and you just have to upgrade your code along with upgrading to CGE 6.5 / 7.0.</p>
</div>
<div class="paragraph">
<p><a href="https://castle-engine.io/talk.php">If you are unsure how to upgrade something, or why something changed, please talk with us!</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>TUIControl.RenderStyle</code> is removed. It was a convoluted way to specify rendering order. Now, only the position of the control among the children (when you <code>InsertFront</code>, <code>InsertBack</code> etc.) determines the rendering order.</p>
</li>
<li>
<p>The default <code>TCastleLabel</code> color is now <code>Black</code>, not <code>White</code>. This compatibility break seemed unavoidable, unfortunately our UI controls were inconsistent&#8201;&#8212;&#8201;most assumed a modern "black colors over white background scheme" (TCastleEdit, TCastleRectangleControl, TCastleCheckbox&#8230;&#8203;), but TCastleLabel was by default white. So it e.g. was invisible over default TCastleRectangleControl.</p>
<div class="paragraph">
<p>If you depended that the label is by default white, then now simply adjust your code to always set <code>MyLabel.Color := White</code> after creating <code>MyLabel := TCastleLabel.Create(...)</code>. Alternatively, temporarily, you can set <code>Theme.DefaultLabelWhite := true</code> at the initialization of your game. (But beware that <code>Theme.DefaultLabelWhite</code> is only a temporary compatibility crutch. It doesn&#8217;t play nicely with designs created in CGE editor, since the (de)serialization will still assume that by default label has white color.)</p>
</div>
</li>
<li>
<p>The default <code>TCastleSceneManager.BackgroundColor</code> is now very dark gray <code>Vector4(0.1, 0.1, 0.1, 1)</code>, instead of pure black <code>Vector4(0, 0, 0, 1)</code>. This makes a better default, as pure black things (3D / 2D models, or user interface, like labels) are still visible over this background (as well as pure white things).</p>
<div class="paragraph">
<p>If you&#8217;d like to restore the old default, just set <code>MySceneManager.BackgroundColor := Black</code> after creating any <code>TCastleSceneManager</code> instance. If you use <code>TCastleWindow</code> or <code>TCastleControl</code> or <code>TCastle2DControl</code>, they contain a default scene manager. You can trivially modify it&#8217;s properties by e.g. <code>Window.SceneManager.BackgroundColor := Black</code>.</p>
</div>
<div class="paragraph">
<p>Note that this doesn&#8217;t matter if you use <a href="https://castle-engine.io/x3d_implementation_environmentaleffects.php">Background node to specify a background color (or skybox textures) in X3D</a>. It also doesn&#8217;t matter if your scene manager is transparent (<code>TCastleSceneManager.Transparent</code> is <code>true</code>). In these cases, scene manager <code>BackgroundColor</code> doesn&#8217;t matter.</p>
</div>
</li>
<li>
<p><em>The user interface coordinates (all positions, sizes, as well as font sizes) are float-based now.</em> See <a href="https://castle-engine.io/wp/2018/10/21/big-user-interface-and-editor-improvements/">this post</a> for details. In some cases, you may need to adjust your code. For example if you do <code>SomeIntValue := MyOtherControl.Width div 2;</code>, now you will have to change it to <code>SomeFloatValue := MyOtherControl.Width / 2;</code>.</p>
</li>
<li>
<p>The interpretation of <code>FullSize=true</code> is now consistent across all <code>TCastleUserInterface</code> ancestors. It <em>always</em> overrides the control to fill the parent.</p>
<div class="paragraph">
<p>So <code>FullSize=true</code> works the same. Even for <code>TCastleButton</code>. Even for <code>TCastleImageControl</code> with <code>TCastleImageControl.Stretch=false</code> value.</p>
</div>
<div class="paragraph">
<p>Also, changing <code>Left</code>/<code>Bottom</code> properties doesn&#8217;t matter when you use <code>FullSize</code>. Previously, it was possible to use <code>FullSize</code> to have a rectangle with the same size as parent, but still move it using <code>Left</code>/<code>Bottom</code> properties. It is no longer possible: <code>FullSize</code> always means <em>fill the parent</em>, so the rendered area of the control covers the parent. You can use <code>WidthFraction := 1; HeightFraction := 1;</code> to set size equal to the parent, but control the position as you like.</p>
</div>
</li>
<li>
<p><code>TCastleImageControl.ProportionalScaling</code> values <code>psFit</code> and <code>psEnclose</code> work a bit differently.</p>
<div class="paragraph">
<p>Previously, they placed the scaled image in the middle of the rectangle determined by <code>Left</code>,<code>Bottom</code>,<code>Width</code>,<code>Height</code>. Now, auto-sizing changes size, but the content keeps at the same left-bottom corner. So the scaled image&#8217;s left-bottom corner is always at the position indicated by <code>Left</code>,<code>Bottom</code> properties.</p>
</div>
<div class="paragraph">
<p>To center image, just use <code>MyImageControl.Anchor(hpMiddle); MyImageControl.Anchor(vpMiddle);</code>.</p>
</div>
<div class="paragraph">
<p>This is consistent with other UI controls.</p>
</div>
</li>
<li>
<p>Anchors are always <em>on</em> now. The ability to turn them on / off in previous CGE versions was more confusing than helpful, and it was also useless.</p>
<div class="paragraph">
<p>Previously you could deactivate anchor by setting <code>HasHorizontalAnchor</code> to <code>false</code> (in fact, it was <code>false</code> by default). Now, you should achieve the same effect by calling <code>Anchor(hpLeft);</code> (which is also the default state). This aligns left control border to left parent border with 0 delta, which has the same effect as "no anchor".</p>
</div>
</li>
<li>
<p>Some components are no longer registered on the component palette. To bring them back (e.g. to open LFM files that refer to these components), you can define <code>{$define CASTLE_REGISTER_ALL_COMPONENTS_IN_LAZARUS}</code> to the <code>src/castleconf.inc</code> file. See <a href="https://github.com/castle-engine/castle-engine/commit/5cb6fb2ea3a4159cf7d371b6abde42acc667a515">this commit log</a> for reasons.</p>
</li>
<li>
<p><code>TCastleFont.Scale</code> was removed (as it was a trap, due to how it was implemented and specified, it was only working on some <code>TCastleFont</code> descendants). Use only <code>TCastleFont.Size</code>. For <code>TTextureFont</code> (which is the most commonly used font descendant) the <code>Scale</code> property is still present, so usually writing <code>Font.Scale := 0.5</code> continues to work, if <code>Font</code> is of class <code>TTextureFont</code>.</p>
</li>
<li>
<p>By default, fonts show a fallback glyph (like "?") if you try to render a missing character in the font. This is usually a good idea&#8201;&#8212;&#8201;it allows the user to see that something is there (so e.g. "backspace" makes sense, otherwise you would "backspace" invisible characters sometimes), the developer knows that something is missing (the <a href="https://castle-engine.io/manual_log.php">log</a> will also contain warnings about missing characters). However, if you want to restore previous behavior (that silently ignores missing glyphs) set <code>TTextureFont.FontData.UseFallbackGlyph := false</code>.</p>
</li>
<li>
<p><code>TGLImage.ClipLine</code> and <code>TCastleImageControl.ClipLine</code> are expressed in local (texture) image coordinates, in which image <code>(X, Y)</code> span from <code>(0, 0)</code> (bottom-left) to <code>(1, 1)</code> (top-right). Previously, they worked in the final screen coordinates. The new definition is much more useful, it allows to express common use-cases with a constant equation, e.g. reject left half of the image by <code>ClipLine = (1, 0, 0.5)</code>, regardless of the image size and position on the screen. It also plays nicely with UI scaling&#8201;&#8212;&#8201;the previous definition was working in final device screen coordinates, and we avoid exposing them in UI API.</p>
</li>
<li>
<p><code>TCastleButton.Image</code> and 4x <code>TCastleButton.CustomBackgroundXxx</code> properties change from TCastleImage to TCastleImagePersistent. Instead of assigning them like</p>
<div class="listingblock">
<div class="content">
<pre>  MyButton.CustomBackgroundNormal := LoadImage('castle-data:/my_image.png');
  MyButton.OwnsCustomBackgroundNormal := true;</pre>
</div>
</div>
<div class="paragraph">
<p>you should now use</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  MyButton.CustomBackgroundNormal.URL := 'castle-data:/my_image.png';</pre>
</div>
</div>
<div class="paragraph">
<p>Eventually, you can also do more elaborate version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  MyButton.CustomBackgroundNormal.Image := LoadImage('castle-data:/my_image.png');
  MyButton.CustomBackgroundNormal.OwnsImage := true; // actually this is no longer needed</pre>
</div>
</div>
<div class="paragraph">
<p>The contained image is now owned by default, which makes the usual use-case simpler. So the behavior is like previous <code>TCastleButton.OwnsImage</code>, <code>TCastleButton.OwnsCustomBackgroundXxx</code> would be <code>true</code> by default. This change is the reason why we break compatibility&#8201;&#8212;&#8201;although we could make an API that <em>seems</em> backward-compatible (that is, <em>compiles OK</em>), but it would have bad consequences at runtime, with applications crashing, since the default of <code>OwnsXxx</code>  is now true (and you would free the same pointer two times, in some circumstances). We decided that it&#8217;s better to break compatibility at compile-time.</p>
</div>
<div class="paragraph">
<p>This change makes it possible to easily configure these images using CGE editor. But it also makes configuring these images through code easier.</p>
</div>
<div class="paragraph">
<p>Moreover, there is an underlying cache (of both TEncodedImage and TDrawableImage) used. So you can set multiple images to the same URL, and don&#8217;t worry about the resources duplication on GPU&#8201;&#8212;&#8201;we will actually share all the resources underneath, across all <code>TCastleImagePersistent</code> with the same URL. (You can turn it off by <code>TCastleImagePersistent.Cache</code> is special circumstances, e.g. when loading image from URL but then editing it at runtime in some controls.)</p>
</div>
<div class="paragraph">
<p>Also <code>TCastleButton.CustomBackgroundCorners</code> and <code>TCastleButton.ImageAlphaTest</code> are removed. They are replaced by new settings inside <code>TCastleImagePersistent</code> subcomponents, In particular you have <code>MyButton.CustomBackgroundXxx.ProtectedSides</code> and <code>MyButton.Image.Alpha</code>.</p>
</div>
</li>
<li>
<p>The callback <code>TAdClosedEvent</code> (used by <code>TAds.OnFullScreenAdClosed</code>) parameters changed.</p>
<div class="ulist">
<ul>
<li>
<p>Previously they were <code>(const Sender: TObject; const Watched: boolean)</code>.</p>
</li>
<li>
<p>Now they are <code>(const Sender: TObject; const WatchedStatus: TAdWatchStatus)</code>. The <code>WatchedStatus</code> enum provides more detailed information why the ad was not watched.</p>
</li>
<li>
<p>To upgrade your code easily, change the <code>Watched: boolean</code> &#8594; <code>WatchedStatus: TAdWatchStatus</code> declaration and instead of <code>Watched</code> use <code>WatchedStatus = wsWatched</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If you use <a href="https://castle-engine.io/creating_data_sound.php">sounds XML file with importance</a> note that the default value of <code>default_importance</code> is now <code>10</code> (not maximum 2147483647). So sounds that had <code>default_importance</code> not explicitly specified are now treated as <em>less</em> important than e.g. <code>default_importance="player"</code>. To easily restore previous behavior, just add <code>default_importance="maximum"</code> for sounds without explicit <code>default_importance</code> attribute.</p>
<div class="paragraph">
<p>Note that this doesn&#8217;t matter if you use sounds XML file, but never specify <code>default_importance</code>. In this case, all sounds have the same importance, and it&#8217;s numerical value doesn&#8217;t matter.</p>
</div>
<div class="paragraph">
<p>It also doesn&#8217;t matter in practice if you never play more than 16 sounds simultaneously at once. The "importance" doesn&#8217;t matter if you don&#8217;t play too many sounds at once.</p>
</div>
</li>
<li>
<p>We disabled the default behavior of limiting gravity to only work within the level bounding box. It was non-obvious, and often a trap for newcomers ("why does gravity not work if I jump high?").</p>
<div class="paragraph">
<p>An improved version of it (eliminating the above "why does gravity not work if I jump high?" problem) is now available through <code>PreventInfiniteFallingDown</code>, which is by default <code>false</code> (to be safe). So if you relied on this, consider using <code>Viewport.PreventInfiniteFallingDown := true</code>.</p>
</div>
<div class="paragraph">
<p>You can also assign <code>SceneManager.OnMoveAllowed</code> event to do something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="pascal">  <span class="comment">{ Don't let objects/camera fall outside of the box because of gravity,
    as then they would fall into infinity. }</span>
  <span class="keyword">if</span> BecauseOfGravity <span class="keyword">then</span>
    Allowed := Items.BoundingBox.Contains(NewPosition);</code></pre>
</div>
</div>
</li>
<li>
<p>When creating resources from <code>CastleCreatures</code> and <code>CastleItems</code> units, pass <code>SceneManager.LevelProperties</code> as 1st argument, instead of <code>SceneManager.Items</code>.</p>
</li>
<li>
<p>Since <a href="https://github.com/castle-engine/castle-engine/commit/42307ed4d6063da87436a3b9e4d930d2f52e61c7">this commit</a>: <code>TShapeNode.Material</code> is now <code>TAbstractMaterialNode</code>, not a more specific <code>TMaterialNode</code>.</p>
<div class="paragraph">
<p>This may affect you if you used construction like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="pascal">  Shape.Material := TMaterialNode.Create; <span class="comment">// this still works OK</span>
  Shape.Material.DiffuseColor := GreenRgb; <span class="comment">// this will not compile anymore</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>Shape.Material</code> is now <code>TAbstractMaterialNode</code>, and <code>TAbstractMaterialNode</code> doesn&#8217;t have <code>DiffuseColor</code> property, this will not compile anymore.</p>
</div>
<div class="paragraph">
<p>Instead use local variable <code>Mat: TMaterialNode</code> and do it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="pascal">  Mat := TMaterialNode.Create;
  Mat.DiffuseColor := GreenRgb;
  Shape.Material := Mat;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Reason for breakage</strong>: Other material descendants are possible in CGE 7.0:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>TUnlitMaterial</code>. Useful for unlit shapes, see <a href="https://github.com/michaliskambi/x3d-tests/wiki/X3D-version-4:-New-features-of-materials,-lights-and-textures">X3D 4.0 materials</a>.</p>
</li>
<li>
<p><code>TPhysicalMaterial</code>. Physically-based rendering, see <a href="https://github.com/michaliskambi/x3d-tests/wiki/X3D-version-4:-New-features-of-materials,-lights-and-textures">X3D 4.0 materials</a>.</p>
</li>
<li>
<p><code>TTwoSidedMaterialNode</code>. Acting just like one-sided material for now (<code>separateBackColor</code> is ignored, and the two-sidedness is actually determined by geometry <code>solid</code> field, following X3D spec).</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>TCastleSceneManager.OnMoveAllowed</code> callback is removed. You can use <code>TCastleWalkNavigation.OnMoveAllowed</code> instead. Or set invisible colliders to limit the movement.</p>
</li>
<li>
<p><code>TCastleViewport</code> by default has <code>FullSize</code>, <code>AutoCamera</code>, <code>AutoNavigation</code> set to <code>false</code>. Set them to <code>true</code> to have exact behavior from previous engine versions.</p>
</li>
<li>
<p>The management of levels and player in <code>CastleLevels</code>, <code>CastlePlayer</code> was upgraded in a few ways. In particular, you should now <em>never</em> add <code>Player</code> instance manually to <code>Viewport.Items</code> (so do not call <code>Viewport.Items.Add(Player)</code> yourself). Also, always assign <code>TLevel.Player</code> <em>before</em> calling  <code>TLevel.Load</code>.</p>
</li>
<li>
<p><code>TCastleTransform.DefaultOrientation</code> changed from <code>otUpYDirectionMinusZ</code> to <code>otUpYDirectionZ</code>. Reason:</p>
<div class="ulist">
<ul>
<li>
<p>First of all, this matches the default orientation made by Blender exporter to glTF and Wavefront OBJ. This way, if you create a model in Blender following Blender&#8217;s conventions of views (Front / Back, Left  / Right, Top / Bottom) and then load this in CGE, then <code>TCastleTransform.Direction</code> will behave in an intuitive manner out-of-the-box.</p>
<div class="paragraph">
<p>I checked how it looks for formats exported from Blender (by default):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Exporting to obj, bvh, fbx, gltf: changes up from +Z (Blender) into +Y, and has <code>axis_forward='-Z'</code> (which matches our <code>otUpYDirectionZ</code>)</p>
</li>
<li>
<p>Exporting to x3d: changes up from +Z (Blender) into +Y, and has <code>axis_forward='Z'</code> (which matches our <code>otUpYDirectionMinusZ</code>)</p>
</li>
<li>
<p>Exporting to ply, stl: makes no change (Blender&#8217;s +Z remains +Z after export)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This can be checked by searching <code>orientation_helper</code> in Blender&#8217;s scripts sources (done on 2.82):</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre>io_scene_obj/__init__.py:52:        orientation_helper,
io_scene_obj/__init__.py:58:@orientation_helper(axis_forward='-Z', axis_up='Y')
io_scene_obj/__init__.py:328:@orientation_helper(axis_forward='-Z', axis_up='Y')
io_mesh_ply/__init__.py:56:    orientation_helper
io_mesh_ply/__init__.py:95:@orientation_helper(axis_forward='Y', axis_up='Z')
io_scene_x3d/__init__.py:51:        orientation_helper,
io_scene_x3d/__init__.py:57:@orientation_helper(axis_forward='Z', axis_up='Y')
io_scene_x3d/__init__.py:165:@orientation_helper(axis_forward='Z', axis_up='Y')
io_anim_bvh/__init__.py:53:    orientation_helper,
io_anim_bvh/__init__.py:58:@orientation_helper(axis_forward='-Z', axis_up='Y')
io_mesh_stl/__init__.py:67:    orientation_helper,
io_mesh_stl/__init__.py:76:@orientation_helper(axis_forward='Y', axis_up='Z')
io_mesh_stl/__init__.py:206:@orientation_helper(axis_forward='Y', axis_up='Z')
io_scene_fbx/__init__.py:57:        orientation_helper,
io_scene_fbx/__init__.py:63:@orientation_helper(axis_forward='-Z', axis_up='Y')
io_scene_fbx/__init__.py:378:@orientation_helper(axis_forward='-Z', axis_up='Y')</pre>
</div>
</div>
<div class="paragraph">
<p>+
So X3D is the only format where <code>otUpYDirectionMinusZ</code> made sense. And <a href="https://castle-engine.io/creating_data_blender.php">Blender X3D exporter isn&#8217;t really useful right now</a> and we advise using glTF.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Looking at sample glTF characters from Khronos&#8201;&#8212;&#8201;they confirm this convention. So it&#8217;s not a Blender+glTF convention, it&#8217;s a glTF convention. (Actually, convention of all other 3D formats too, looking at above.)</p>
</li>
<li>
<p>And exporting models like this makes more sense, so it&#8217;s actually good that most formats follow it. It means that model front looks into +Z. So if you view it with the default camera (that has direction -Z) then you see model&#8217;s front (e.g. face).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Some <code>CastleCameras</code> properties were still in degrees (while the majority of engine used radians for angles). They were changed to be in radians. You may need to update your constants/limits. This affects <code>MouseLookHorizontalSensitivity</code>, <code>MouseLookVerticalSensitivity</code>, <code>RotationHorizontalSpeed</code>, <code>RotationVerticalSpeed</code>.</p>
</li>
<li>
<p><code>TPlayer.Navigation</code> is now <code>TCastleMouseLookNavigation</code> instance, not <code>TCastleWalkNavigation</code> instance. That&#8217;s because <code>TPlayer.Navigation</code> is now a function, it can return either <code>TPlayer.WalkNavigation</code> (<code>TCastleWalkNavigation</code> instance) or <code>TPlayer.ThirdPersonNavigation</code> (<code>TCastleThirdPersonNavigation</code> instance).</p>
<div class="paragraph">
<p>Bottom line: If you have code doing <code>Player.Navigation.Xxx</code> where <code>Xxx</code> is some <code>TCastleWalkNavigation</code> property, just change the code to use <code>Player.WalkNavigation.Xxx</code>.</p>
</div>
</li>
<li>
<p><code>TCastleTransform.PointingDeviceActivate</code> has been removed, and replaced by 2 events <code>TCastleTransform.PointingDevicePress</code>, <code>TCastleTransform.PointingDeviceRelease</code>. They also get additional information as an argument <code>Pick: TRayCollisionNode</code> which allows you to e.g. instantly see what shape (what material etc.) was clicked, if your scene had detailed collisions (<code>Spatial</code> includes <code>ssDynamicCollisions</code>). Like this:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="pascal">  <span class="keyword">function</span> TMyScene.PointingDevicePress(
    <span class="keyword">const</span> Pick: TRayCollisionNode; <span class="keyword">const</span> Distance: Single): Boolean;
  <span class="keyword">begin</span>
    Result := <span class="keyword">inherited</span>;
    <span class="keyword">if</span> Result <span class="keyword">then</span> Exit;

    WritelnLog(<span class="string"><span class="delimiter">'</span><span class="content">Pressed pointing device</span><span class="delimiter">'</span></span>);
    <span class="keyword">if</span> (Pick.Triangle &lt;&gt; <span class="keyword">nil</span>) <span class="keyword">and</span>
       (Pick.Triangle^.MaterialInfo &lt;&gt; <span class="keyword">nil</span>) <span class="keyword">then</span>
      WritelnLog(<span class="string"><span class="delimiter">'</span><span class="content">Pressed on material </span><span class="delimiter">'</span></span> + Pick.Triangle^.MaterialInfo.Node.X3DName);
  <span class="keyword">end</span>;</code></pre>
</div>
</div>
</li>
<li>
<p>The <code>RenderContext</code> singleton and related types has been moved to <code>CastleRenderContext</code> unit. Add it to your uses clause, if necessary.</p>
</li>
<li>
<p>Some enumerated types have been moved to <code>CastleRenderOptions</code>. Add it to your uses clause, if necessary.</p>
</li>
<li>
<p>Do not use <code>CastleRenderer</code> unit anymore. It contained a lot of internal things, which are now moved to <code>CastleInternalRenderer</code>. The only important feature there were rendering attributes, now in unit <code>CastleRenderOptions</code>. The <code>CastleRenderer</code> unit is now only a skeleton for backward-compatibility.</p>
</li>
<li>
<p><code>NewGLUQuadric</code> and <code>CastleGluSphere</code> are removed. These were "thin" wrappers over libGLU quadric routines, and we no longer use libGLU. They have been marked "deprecated" since a long time, and they never worked on mobile.</p>
<div class="paragraph">
<p>To render quadrics, use TCastleScene, with various 3D and 2D primitives <a href="https://castle-engine.io/x3d_implementation_geometry3d.php" class="bare">https://castle-engine.io/x3d_implementation_geometry3d.php</a> , <a href="https://castle-engine.io/x3d_implementation_geometry2d.php" class="bare">https://castle-engine.io/x3d_implementation_geometry2d.php</a> like TSphereNode, TDisk2DNode etc.</p>
</div>
</li>
<li>
<p><a href="https://castle-engine.io/apidoc-unstable/html/CastleTransform.TCastleTransform.html#Press">TCastleTransform.Press</a>, <a href="https://castle-engine.io/apidoc-unstable/html/CastleTransform.TCastleTransform.html#Release">TCastleTransform.Release</a> are now only called when <a href="https://castle-engine.io/apidoc-unstable/html/CastleTransform.TCastleTransform.html#ListenPressRelease">TCastleTransform.ListenPressRelease</a> is <code>true</code>.</p>
<div class="paragraph">
<p>The need to process keys in TCastleTransform is very seldom (we only had 2 use-cases for it in the engine, one is in soon-to-be-deprecated <code>CastlePlayer</code>, the other was for <a href="https://castle-engine.io/x3d_implementation_keydevicesensor.php">X3D key sensors</a> which are not very useful to normal engine usage).</p>
</div>
</li>
<li>
<p><code>TLevelLogic</code> is now <code>TCastleBehavior</code> descendant. Overriding <code>TLevelLogic.Create</code> and <code>TLevelLogic.Update</code> still has the same effect though, so you may not notice much difference. Note that <code>TLevelLogic</code> instance is not yet part of the world when <code>TLevelLogic.Create</code> happens (override <code>TLevelLogic.ParentChanged</code> to do something once it&#8217;s part of level; we may introduce event like <code>WorldChanged</code> if necessary too).</p>
</li>
<li>
<p>The speed of movement in case of <code>TCastleExamineNavigation</code> with orthographic projection and standard dir/up (+Z/+Y) is now more natural. You can revert to previous behavior by setting <code>TCastleExamineNavigation.ExactMovement</code> to <code>false</code>.</p>
</li>
<li>
<p><code>TCastleFont</code> is now <code>TCastleAbstractFont</code>, and <code>TTextureFont</code> is now <code>TCastleFont</code>. If you use <code>TCastleFont</code> class name explicitly, this affects you. Now:</p>
<div class="ulist">
<ul>
<li>
<p><code>TCastleFont</code> is the (non-abstract) font class that allows to load font from file (ttf, otf)</p>
</li>
<li>
<p><code>TCastleAbstractFont</code> is the abstract ancestor for all font classes (TCastleFont, TCastleBitmapFont, TCastleFontFamily etc.)</p>
</li>
</ul>
</div>
</li>
<li>
<p>We used to support randomization in <a href="https://castle-engine.io/creating_data_sound.php">sounds XML file</a>:</p>
<div class="paragraph">
<p>An alias could have more than one target, which means that actual sound will be randomly chosen from the available options
each time you play this alias.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  &lt;?xml version="1.0"?&gt;
  &lt;sounds&gt;
    &lt;alias name="random_test_sound"&gt;
      &lt;target name="test_sound_1" /&gt;
      &lt;target name="test_sound_2" /&gt;
      &lt;target name="test_sound_3" /&gt;
    &lt;/alias&gt;
  &lt;/sounds&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>This no longer works, and it will not work. As we move away from sounds XML file (in favor of settings sounds in file like <code>all_sounds.castle-component</code>) and keeping this functionality would require some hoops (<code>SoundFromName</code> would have to return something else than <code>TCastleSound</code>, making it cumbersone for more typical usage). That is, defining a "random" sound name (that, each time you play it, randomly chooses one actual sound from a list) in the sounds XML file no longer works. It will now randomize only once (at "SoundFromName" call, i.e. when you resolve String -&gt; TCastleSound), and later use this sound each time you play it.</p>
</div>
<div class="paragraph">
<p>If you want to have such random sounds, now we advise you implement this on top of CGE. Just define a few TCastleSound instances, and choose a random one yourself, like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="pascal">  <span class="keyword">function</span> BulletSound: TCastleSound;
  <span class="keyword">begin</span>
    <span class="keyword">case</span> Random(<span class="integer">3</span>) <span class="keyword">of</span>
      <span class="integer">0</span>: Result := SoundBullet1;
      <span class="integer">1</span>: Result := SoundBullet2;
      <span class="integer">2</span>: Result := SoundBullet3;
    <span class="keyword">end</span>;
  <span class="keyword">end</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A complete example how to realize this approach, in a way as-backward-compatible-as-possible, is on <a href="https://gist.github.com/michaliskambi/5f9e8df6021434a0dd47508a3cac1ec3" class="bare">https://gist.github.com/michaliskambi/5f9e8df6021434a0dd47508a3cac1ec3</a> .</p>
</div>
<div class="paragraph">
<p>Another possibility, temporary, to resolve it is to just use <code>SoundFromName</code> each time before playing such sound. So do not store the <code>SoundFromName</code> result for a longer time, instead play it like <code>SoundEngine.Sound(SoundFromName('xxx'))</code>.</p>
</div>
</li>
<li>
<p><code>TCastleUserInterface.LocalToScreenPosition</code> was removed, as both the word "local" (was actually implemented as meaning "parent coordinate system", not local) and "screen" (was actually meaning "container") were confusing. Use <code>LocalToContainerPosition</code>, <code>Parent.LocalToContainerPosition</code>, <code>ContainerToLocalPosition</code>, <code>Parent.ContainerToLocalPosition</code> depending on needs.</p>
</li>
</ul>
</div>