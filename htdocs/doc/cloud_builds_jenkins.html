<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#_features_overview">Features Overview</a></li>
<li><a href="#_using_it">Using it</a>
<ul class="sectlevel1">
<li><a href="#_configure_and_view_the_job_in_jenkins_web_view">1. Configure and view the job in Jenkins (web view)</a></li>
<li><a href="#_configure_what_commands_are_executed_to_do_the_job_jenkinsfile">2. Configure what commands are executed to do the job (Jenkinsfile)</a>
<ul class="sectlevel2">
<li><a href="#_specify_how_to_build_your_project">2.1. Specify how to build your project</a></li>
<li><a href="#_choose_castle_game_engine_version_by_choosing_docker_image">2.2. Choose Castle Game Engine version (by choosing Docker image)</a></li>
<li><a href="#_choose_fpc_and_lazarus_version">2.3. Choose FPC and Lazarus version</a></li>
<li><a href="#_email_notifications">2.4. Email notifications</a></li>
<li><a href="#_save_the_resulting_files_archive_artifacts">2.5. Save the resulting files (archive artifacts)</a></li>
<li><a href="#_more_ideas_for_things_that_can_be_done">2.6. More ideas for things that can be done</a></li>
<li><a href="#_jenkinsfile_examples">2.7. Jenkinsfile examples</a></li>
<li><a href="#_jenkinsfile_documentation">2.8. Jenkinsfile documentation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>We maintain an official <a href="https://jenkins.castle-engine.io/">Cloud Builds (Jenkins)</a> server.</p>
</div>
<div class="paragraph">
<p>Table of Contents:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#features-overview">Features Overview</a></p>
</li>
<li>
<p><a href="#using-it">Using it</a></p>
<div class="ulist">
<ul>
<li>
<p><a href="#configure-and-view-the-job-in-jenkins-web-view">Configure and view the job in Jenkins (web view)</a></p>
</li>
<li>
<p><a href="#configure-what-commands-are-executed-to-do-the-job-jenkinsfile">Configure what commands are executed to do the job (Jenkinsfile)</a></p>
<div class="ulist">
<ul>
<li>
<p><a href="#specify-how-to-build-your-project">Specify how to build your project</a></p>
</li>
<li>
<p><a href="#choose-castle-game-engine-version-by-choosing-docker-image">Choose Castle Game Engine version (by choosing Docker image)</a></p>
</li>
<li>
<p><a href="#choose-fpc-and-lazarus-version">Choose FPC and Lazarus version</a></p>
</li>
<li>
<p><a href="#email-notifications">Email notifications</a></p>
</li>
<li>
<p><a href="#save-the-resulting-files-archive-artifacts">Save the resulting files (archive artifacts)</a></p>
</li>
<li>
<p><a href="#more-ideas-for-things-that-can-be-done">More ideas for things that can be done</a></p>
</li>
<li>
<p><a href="#jenkinsfile-examples">Jenkinsfile examples</a></p>
</li>
<li>
<p><a href="#jenkinsfile-documentation">Jenkinsfile documentation</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_features_overview" class="sect0">Features Overview</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>On the server, you can build <em>Castle Game Engine</em> projects in an automated fashion.</p>
</div>
<div class="paragraph">
<p>The service is available as a reward for <a href="https://www.patreon.com/castleengine">supporting CGE on Patreon at a higher tier</a>. We also use it internally, to test CGE itself after every commit.</p>
</div>
<div class="paragraph">
<p>The plan is to make the service completely free for <em>public open-source projects</em>. Please <a href="https://www.patreon.com/castleengine">support CGE on Patreon to make it happen!</a></p>
</div>
<div class="paragraph">
<p>If you are interested in this, just <a href="mailto:michalis@castle-engine.io">send an email to Michalis Kamburelis</a>. We will set everything up.</p>
</div>
<div class="paragraph">
<p>What it does:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We automatically rebuild and package your game when you make a commit to SVN or GIT repository. You also get a web access to trigger the build <em>now</em>.</p>
</li>
<li>
<p>We have a ready FPC/Lazarus build environment for Windows 32-bit, Windows 64-bit, Linux 64-bit (x86_64) and  Android. The FPC versions can be chosen for each build, any version supported by CGE (like 3.0.2, 3.0.4, 3.2.0, fresh 3.3.1) is supported. So you can check whether your software compiles with all FPC versions that matter to you.</p>
</li>
<li>
<p>The builds can use <a href="https://castle-engine.io/">Castle Game Engine latest stable release</a>, or <a href="https://github.com/castle-engine/castle-engine/">Castle Game Engine bleeding-edge version from GitHub</a>. In the latter case, each commit to CGE will also cause a rebuild of your project, so you always stay current.</p>
</li>
<li>
<p>The builds can be done using CGE <a href="https://github.com/castle-engine/castle-engine/wiki/Build-Tool">build tool</a>. You can also use custom shell scripts, if you know your way around Unix shell scripting. In any case, I will help you set everything up, so don&#8217;t fear!:)</p>
</li>
<li>
<p>You can browse the build history of your projects, see which commits failed/succeeded to compile, download the packages from each build (latest build, or a historic one), see compilation logs and more. You can also get automatic email notification when a build fails.</p>
</li>
<li>
<p>We can also automatically run tests of your game (e.g. you can use FpcUnit testing framework, built in FPC).</p>
</li>
<li>
<p>We can also automatically generate API docs of your code (using FpDoc or PasDoc), and upload them somewhere.</p>
</li>
<li>
<p>You can run <a href="https://github.com/castle-engine/castle-engine/wiki/Build-Tool#auto-generate-textures">auto-generate-textures command of the build tool</a>. All command-line utilities (used internally by the build tool, e.g. NVidia Texture Tools) are already installed for you.</p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_using_it" class="sect0">Using it</h1>
<div class="sect1">
<h2 id="_configure_and_view_the_job_in_jenkins_web_view">1. Configure and view the job in Jenkins (web view)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Login to <a href="https://jenkins.castle-engine.io/" class="bare">https://jenkins.castle-engine.io/</a> with your username/password.</p>
</div>
<div class="paragraph">
<p>Notes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For now, there is no automatic registration. Instead just <a href="mailto:michalis@castle-engine.io">send an email to Michalis Kamburelis</a> with your desired Jenkins username, and I will create it for you. You will receive an automatically generated password (which you can later change from Jenkins yourself).</p>
</li>
<li>
<p>It is best to configure your account such that your username matches the SVN username (if you use SVN) and/or your email matches your GIT email (if you use GIT). This way your commits will be automatically matched to you in Jenkins.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>TODO: For now, I will also create a project for you.</p>
</div>
<div class="paragraph">
<p>In Jenkins, you can configure the project&#8217;s repository (GIT, SVN) and how often it is checked for modifications, repository credentials (if the project is not publicly accessible) and some more.</p>
</div>
<div class="paragraph">
<p>TODO screenshot</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If your repository is private (not publicly accessible), you will need to input your credentials (username/password to login to SVN/GIT). I advice creating a read-only account for your repository (e.g. called <code>jenkins</code>) for this purpose. For best security, <em>do not</em> use your regular read-write account to get the repository contents inside Jenkins. I do my best to keep this Jenkins installation secure (and we are using this server for various <a href="http://cat-astrophe-games.com/">private projects at Cat-astrophe Games</a>, so we really trust it with content that must be secure), but you should follow the rule <em>"reveal as little as possible"</em> anyway.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On the Jenkins page, you can see the statistics about recent builds (how long they took, whether they succeeded) and you can download <em>artifacts</em> of your project. The <em>"artifacts"</em> are just files that you consider the "output" from the build process. In case of CGE games, it is usually a couple of archives like <code>my_game-0.1.0-linux-x86_64.tar.gz</code>, <code>my_game-0.1.0-win32-i386.zip</code>, <code>my_game-0.1.0-win64-x86_64.zip</code>, produced by the <a href="https://github.com/castle-engine/castle-engine/wiki/Build-Tool#package">build tool <code>package</code> command</a>.</p>
</div>
<div class="paragraph">
<p>You can also see the logs for each build. If a build compilation failed, these logs will contain the information "why". The <em>logs are the first thing to consult</em> if you want to know what happened (and what failed) during the build.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_what_commands_are_executed_to_do_the_job_jenkinsfile">2. Configure what commands are executed to do the job (Jenkinsfile)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_specify_how_to_build_your_project">2.1. Specify how to build your project</h3>
<div class="paragraph">
<p>Place a file named <code>Jenkinsfile</code> (no extension, and case matters!) in the top-level of your repository. Inside, place this content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pipeline {
  agent { docker { image 'kambi/castle-engine-cloud-builds-tools:cge-stable' } }
  stages {
    stage('Build') {
      steps {
        sh 'castle-engine package --os=linux --cpu=x86_64'
        sh 'castle-engine package --os=win32 --cpu=i386'
        sh 'castle-engine package --os=win64 --cpu=x86_64'
        sh 'castle-engine package --os=android --cpu=arm'
      }
    }
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Of course, remove the lines for platforms you don&#8217;t use. E.g. if your game doesn&#8217;t compile on Android, remove it.</p>
</div>
<div class="paragraph">
<p>You can also comment out the lines. C-like "star comments" are supported, like <code>/* This is a comment. */</code>.</p>
</div>
<div class="paragraph">
<p>It is nice split long-running stages into multiple stages. It is also useful to run everything with <code>--verbose</code> inside Jenkins. So a better version of the above example looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pipeline {
  agent {
    docker {
      image 'kambi/castle-engine-cloud-builds-tools:cge-unstable'
    }
  }
  stages {
    stage('Build Desktop') {
      steps {
        sh 'castle-engine package --os=win64 --cpu=x86_64 --verbose'
        sh 'castle-engine package --os=win32 --cpu=i386 --verbose'
        sh 'castle-engine package --os=linux --cpu=x86_64 --verbose'
      }
    }
    stage('Build Mobile') {
      steps {
        sh 'castle-engine package --os=android --cpu=arm --verbose'
      }
    }
  }
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_choose_castle_game_engine_version_by_choosing_docker_image">2.2. Choose Castle Game Engine version (by choosing Docker image)</h3>
<div class="paragraph">
<p>The image declaration <code>kambi/castle-engine-cloud-builds-tools:cge-stable</code> refers to our <a href="https://hub.docker.com/r/kambi/castle-engine-cloud-builds-tools/">Docker image with Castle Game Engine and various tools (FPC, Lazarus, Android SDK and NDK, &#8230;&#8203;)</a>. It defines an environment in which your build will run. You really don&#8217;t need to be concerned with the details like "what is Docker and how does it work", these are being handled by Jenkins, you only choose a Docker image from 3 possibilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kambi/castle-engine-cloud-builds-tools:cge-stable</code> - stable CGE version.</p>
</li>
<li>
<p><code>kambi/castle-engine-cloud-builds-tools:cge-unstable</code> - unstable CGE version (latest code from GitHub).</p>
</li>
<li>
<p><code>kambi/castle-engine-cloud-builds-tools:cge-none</code> - no CGE inside the container (this is useful for jobs that don&#8217;t need CGE, or that test CGE itself).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you use the <code>castle-engine-cloud-builds-tools:cge-unstable</code> image, I can additionally configure the build to run always after <em>Castle Game Engine</em> changed. (Internally, the build of <code>castle_game_engine_update_image</code> will cause a rebuild of your game.) This way after <em>every commit to Castle Game Engine</em>, your game will be also rebuild to use the latest engine.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_choose_fpc_and_lazarus_version">2.3. Choose FPC and Lazarus version</h3>
<div class="paragraph">
<p>By default, building uses the latest stable FPC version (currently 3.2.0), as advised by CGE. To switch to another FPC/Lazarus version, add a command like <code>source /usr/local/fpclazarus/bin/setup.sh 3.0.2 &amp;&amp; ...</code> or <code>source /usr/local/fpclazarus/bin/setup.sh trunk &amp;&amp; ...</code> at the beginning of the shell command. Like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pipeline {
  agent { docker { image 'castle-engine-cloud-builds-tools:cge-stable' } }
  stages {
    stage('Build') {
      steps {
        sh 'source /usr/local/fpclazarus/bin/setup.sh trunk &amp;&amp; castle-engine package --os=linux --cpu=x86_64'
        sh 'source /usr/local/fpclazarus/bin/setup.sh trunk &amp;&amp; castle-engine package --os=win32 --cpu=i386'
        sh 'source /usr/local/fpclazarus/bin/setup.sh trunk &amp;&amp; castle-engine package --os=win64 --cpu=x86_64'
        sh 'source /usr/local/fpclazarus/bin/setup.sh trunk &amp;&amp; castle-engine package --os=android --cpu=arm'
      }
    }
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, each build can use a different FPC version, if you want to.</p>
</div>
<div class="paragraph">
<p>Note that some FPC versions do not support some targets.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FPC 3.0.2 doesn&#8217;t support any Android CPU (32-bit ARM or 64-bit AArch64).</p>
</li>
<li>
<p>FPC 3.0.4 doesn&#8217;t support Android/AArch64. It only supports 32-bit ARM for Android.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_email_notifications">2.4. Email notifications</h3>
<div class="paragraph">
<p>You can be notified via email when the build fails (e.g. compilation failed) or when it becomes stable again. To do this, add to the <code>Jenkinsfile</code> a section <code>post</code> with this content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pipeline {
  agent { ... }
  stages { ... }
  post {
    regression {
      mail to: 'michalis@castle-engine.io',
        subject: "[jenkins] Build started failing: ${currentBuild.fullDisplayName}",
        body: "See the build details on ${env.BUILD_URL}"
    }
    failure {
      mail to: 'michalis@castle-engine.io',
        subject: "[jenkins] Build failed: ${currentBuild.fullDisplayName}",
        body: "See the build details on ${env.BUILD_URL}"
    }
    fixed {
      mail to: 'michalis@castle-engine.io',
        subject: "[jenkins] Build is again successfull: ${currentBuild.fullDisplayName}",
        body: "See the build details on ${env.BUILD_URL}"
    }
  }
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_save_the_resulting_files_archive_artifacts">2.5. Save the resulting files (archive artifacts)</h3>
<div class="paragraph">
<p>You usually want to save the build files (artifacts) after a successful build. This allows to download them later using Jenkins web interface. To do this, add to the <code>Jenkinsfile</code> a section <code>post</code> with this content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pipeline {
  agent { ... }
  stages { ... }
  post {
    success {
      archiveArtifacts artifacts: 'my_game-*.tar.gz,my_game-*zip,my_game-*.apk'
    }
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>As you see, you just trivially list files (using wildcards like <code>*</code>) to consider "artifacts". Remember to replace <code>my_game</code> with the name of your game project.</p>
</div>
<div class="paragraph">
<p>If you want to archive artifacts, and have email notifications (see the previous section), just combine them both in a single <code>post</code> clause. So <code>post</code> clause will contain subclauses like <code>success</code>, <code>failure</code> and so on. As you can guess, many more possibilities are possible, you can do a <em>lot</em> of things depending on whether a build fails, succeeds and so on.</p>
</div>
</div>
<div class="sect2">
<h3 id="_more_ideas_for_things_that_can_be_done">2.6. More ideas for things that can be done</h3>
<div class="paragraph">
<p>Many, many more possibilities are possible. Jenkins is incredible, IMHO.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can execute any Unix shell script (before, after, or instead of the presented commands). Like this:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>pipeline {
  agent { docker { image 'kambi/castle-engine-cloud-builds-tools:cge-stable' } }
  stages {
    stage('Build') {
      steps {
        sh './my_script.sh'
      }
    }
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>And the script inside <code>my_script.sh</code> should be committed in your repository, and could look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>#!/bin/bash
set -euo pipefail
IFS=$'\n\t'
# See http://redsymbol.net/articles/unofficial-bash-strict-mode/ for the explanation of 2 lines above.

# Remove previous artifacts
rm -f *.tar.gz *.zip *.apk

# Additional command-line options for the build tool
BUILD_TOOL_DEFINE=--compiler-option=-dJENKINS_COMPILATION

# Build for Windows 64-bit, and Linux 64-bit
castle-engine --os=win64 --cpu=x86_64 $BUILD_TOOL_DEFINE package
castle-engine --os=linux --cpu=x86_64 $BUILD_TOOL_DEFINE package</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>You can build and run your test suite using FPCUnit.</p>
</li>
<li>
<p>You can build API documentation using <code>fpdoc</code> or <code>pasdoc</code>. They are both preinstalled in the image. (TODO: Add pasdoc.)</p>
</li>
<li>
<p>You can run <code>castle-engine auto-generate-textures</code>. The tools to make it work are preinstalled in the image.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Docker image contains a basic Debian stable installation. It&#8217;s all executed in a secure Docker container, and will not affect other builds.  After each job execution, the environment is cleared, except the files changed/added inside your project directory.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jenkinsfile_examples">2.7. Jenkinsfile examples</h3>
<div class="paragraph">
<p>We use this approach with all the <em>Castle Game Engine</em> applications. So you can find many <code>Jenkinsfile</code> examples in our repositories. See e.g.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/castle-engine/wyrd-forest/blob/master/Jenkinsfile">"Wyrd Forest" Jenkinsfile</a>, <a href="https://github.com/castle-engine/darkest-before-dawn/blob/master/Jenkinsfile">"Darkest Before The Dawn" Jenkinsfile</a>&#8201;&#8212;&#8201;typical building of cross-platform application.</p>
</li>
<li>
<p><a href="https://github.com/castle-engine/castle-engine/blob/master/Jenkinsfile">"Castle Game Engine" Jenkinsfile</a>&#8201;&#8212;&#8201;trivially run a number of tests.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_jenkinsfile_documentation">2.8. Jenkinsfile documentation</h3>
<div class="paragraph">
<p>For more information about <code>Jenkinsfile</code>, and Jenkins with Pipeline plugin (which is what is happening here), see</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://jenkins.io/doc/pipeline/tour/hello-world/">Jenkins Pipeline documentation</a>.</p>
</li>
<li>
<p><a href="https://jenkins.io/doc/book/pipeline/syntax/">Jenkinsfile syntax</a>. I advise using the "declarative" syntax of <code>Jenkinsfile</code>, as it&#8217;s just simpler. The examples above on this page use it.</p>
</li>
<li>
<p><a href="https://jenkins.io/doc/pipeline/steps/">All possible "steps" (think: "commands you can use") in the Jenkinsfile</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>