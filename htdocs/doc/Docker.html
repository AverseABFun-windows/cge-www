<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#_using_castle_game_engine_inside_a_docker_image">Using Castle Game Engine inside a Docker image</a></li>
<li><a href="#_getting_the_docker_basic_docker_concepts_and_links">Getting the Docker, basic Docker concepts and links</a></li>
<li><a href="#_using_the_docker_image">Using the Docker image</a></li>
<li><a href="#_using_the_docker_image_to_compile_cge_applications">Using the Docker image to compile CGE applications</a></li>
<li><a href="#_limitations">Limitations</a></li>
<li><a href="#_updating_the_docker_image">Updating the Docker image</a></li>
<li><a href="#_sources">Sources</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Table of Contents:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#using-castle-game-engine-inside-a-docker-image">Using Castle Game Engine inside a Docker image</a></p>
</li>
<li>
<p><a href="#getting-the-docker-basic-docker-concepts-and-links">Getting the Docker, basic Docker concepts and links</a></p>
</li>
<li>
<p><a href="#using-the-docker-image">Using the Docker image</a></p>
</li>
<li>
<p><a href="#using-the-docker-image-to-compile-cge-applications">Using the Docker image to compile CGE applications</a></p>
</li>
<li>
<p><a href="#limitations">Limitations</a></p>
</li>
<li>
<p><a href="#updating-the-docker-image">Updating the Docker image</a></p>
</li>
<li>
<p><a href="#sources">Sources</a></p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_using_castle_game_engine_inside_a_docker_image" class="sect0">Using Castle Game Engine inside a Docker image</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>We have a <a href="https://www.docker.com/">Docker</a> image that contains <em>Castle Game Engine</em> along with various tools preconfigured. The image is available on <a href="https://hub.docker.com/r/kambi/castle-engine-cloud-builds-tools/">Docker hub, the image is called "kambi/castle-engine-cloud-builds-tools"</a>.</p>
</div>
<div class="paragraph">
<p>Using the Docker image gives you a stable environment where we have:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Castle Game Engine (stable and unstable versions, depending on the Docker image tag: <code>cge-stable</code>, <code>cge-unstable</code>, <code>cge-none</code>).</p>
</li>
<li>
<p>FPC (stable and unstable versions) with cross-compilers for various platforms</p>
</li>
<li>
<p>Android SDK and NDK</p>
</li>
<li>
<p><a href="https://castle-engine.io/creating_data_auto_generated_textures.php">Texture compression tools useful with CGE</a> from NVidia and PowerVR</p>
</li>
<li>
<p><a href="https://github.com/pasdoc/pasdoc/wiki">PasDoc</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This Docker image is used by our <a href="https://github.com/castle-engine/castle-engine/wiki/Cloud-Builds-(Jenkins)">Cloud Builds (Jenkins)</a> . It can also be used on your local computer. Instead of downloading FPC, CGE, Android SDK and NDK etc., you only have to get the Docker image.</p>
</div>
</div>
</div>
<h1 id="_getting_the_docker_basic_docker_concepts_and_links" class="sect0">Getting the Docker, basic Docker concepts and links</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Follow the <a href="https://www.docker.com/" class="bare">https://www.docker.com/</a> to install Docker. You will most likely want to follow the official docs about <a href="https://docs.docker.com/install/">Installing Docker Community Edition</a>.</p>
</div>
<div class="paragraph">
<p>You should read the <a href="https://docs.docker.com/">Docker documentation</a> and <a href="https://docs.docker.com/reference/">Reference</a> to understand some Docker terminology.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a short version:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>"Docker image"</em> is like a template for a virtual machine.</p>
</li>
<li>
<p><em>"Docker container"</em> is like an actual virtual machine with installed OS (Linux).</p>
</li>
<li>
<p>A stopped container is like a stopped operating system, you can run it again (and have the same files).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are two ways to use Docker container:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can easily create and destroy temporary Docker containers, even to just execute a single command.</p>
</li>
<li>
<p>You can also just create and use one Docker container for a long time.</p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_using_the_docker_image" class="sect0">Using the Docker image</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Commands below may serve as an example how to use our Docker image to easily create a Docker container <code>my-cge-container</code>, and use it quite like a virtual machine.</p>
</div>
<div class="paragraph">
<p>Treat these commands as an example, please. There are various ways of doing this. These commands are written with a Linux user in mind&#8201;&#8212;&#8201;on Windows you will have to adjust them.</p>
</div>
<div class="paragraph">
<p>First run a container from a console like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker run --name my-cge-container --volume="${HOME}":/home/sharedhome/ -it kambi/castle-engine-cloud-builds-tools:cge-unstable bash</pre>
</div>
</div>
<div class="paragraph">
<p>You can play around in the resulting shell, end by Ctrl + D (or <code>exit</code> and Enter).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
we recommend using <code>cge-unstable</code> (CGE 7.0-alpha.snapshot), not <code>cge-stable</code> (6.4) right now. We work intensively on making this the new stable, see <a href="New Features in Castle Game Engine 7.0" class="bare">New Features in Castle Game Engine 7.0</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next time, enter this container like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker start my-cge-container --attach --interactive

# The above command is basically a shortcut for:
#docker start my-cge-container # make container running
#docker attach my-cge-container # attach to the new "bash" process inside</pre>
</div>
</div>
<div class="paragraph">
<p>To remove the container from your system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker rm my-cge-container</pre>
</div>
</div>
<div class="paragraph">
<p>Inside the container, you have a regular Linux command-line.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Try commands like <code>fpc -l</code> or <code>castle-engine --version</code> to make sure you have FPC and CGE inside the container.</p>
</li>
<li>
<p>Try <code>ls /home/sharedhome/</code> to make sure you see your shared directory, if you followed the above example usage of <code>--volume</code>.</p>
</li>
<li>
<p>You can install whatever you need (<code>apt-get install ...</code> works), and just use it as a regular virtual machine.</p>
</li>
<li>
<p>Example above shows using <code>--volume</code> option for <code>docker run</code> to share your $HOME directory. You can also copy files between host/container using <code>docker cp</code> ( <a href="https://docs.docker.com/engine/reference/commandline/cp/" class="bare">https://docs.docker.com/engine/reference/commandline/cp/</a> ).</p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_using_the_docker_image_to_compile_cge_applications" class="sect0">Using the Docker image to compile CGE applications</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Inside the Docker container, just use the installed <code>castle-engine</code> build tool to compile your projects, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cd /home/sharedhome/my-game/
castle-engine compile
castle-engine package</pre>
</div>
</div>
<div class="paragraph">
<p>Your project directory needs to have a <a href="https://github.com/castle-engine/castle-engine/wiki/CastleEngineManifest.xml-examples">CastleEngineManifest.xml</a> file inside. Or you can compile any Pascal source with <code>castle-engine simple-compile someunit.pas</code>. There are many other commands available, see the <a href="https://github.com/castle-engine/castle-engine/wiki/Build-Tool">build tool documentation</a>.</p>
</div>
<div class="paragraph">
<p>You can easily create an Android application (APK file) with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>castle-engine package --target=android</pre>
</div>
</div>
<div class="paragraph">
<p>This way you don&#8217;t need to install all the things mentioned at <a href="https://github.com/castle-engine/castle-engine/wiki/Android&#8201;&#8212;&#8201;they" class="bare">https://github.com/castle-engine/castle-engine/wiki/Android&#8201;&#8212;&#8201;they</a> are already available inside the Docker container. You get an APK, which you can copy to your Android device (phone, tablet) in any way, and then install and run it&#8201;&#8212;&#8201;like any other application in APK form.</p>
</div>
<div class="paragraph">
<p>If you want to <a href="https://castle-engine.io/creating_data_auto_generated_textures.php">generate compressed textures</a>, you can run in Docker container</p>
</div>
<div class="listingblock">
<div class="content">
<pre>castle-engine auto-generate-textures</pre>
</div>
</div>
<div class="paragraph">
<p>The advantage is, again, that you don&#8217;t need to install all the tools mentioned on the <a href="https://castle-engine.io/creating_data_auto_generated_textures.php">generating compressed textures</a> docs. These tools are ready inside the Docker container.</p>
</div>
<div class="paragraph">
<p>You can also use command-line <code>fpc</code> or <code>lazbuild</code> to build Pascal applications. By default we use the latest stable FPC/Lazarus, but this can be switched by executing command like <code>source /usr/local/fpclazarus/bin/setup.sh trunk</code>.  This will make you use FPC 3.3.1 within this shell.</p>
</div>
</div>
</div>
<h1 id="_limitations" class="sect0">Limitations</h1>
<div class="openblock partintro">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><strong>No GUI</strong>. Although <a href="https://www.lazarus-ide.org/">Lazarus</a> is installed inside the container, but it&#8217;s primary use is to run <code>lazbuild</code> to compile Lazarus packages. The container doesn&#8217;t have visual libraries (X) installed, and is not connected to your host display, so you cannot readily use GUI Lazarus for development. It is <a href="http://fabiorehm.com/blog/2014/09/11/running-gui-apps-with-docker/">possible to execute GUI application inside Docker</a>, but it may be easier to just install Lazarus in a normal way, on your host system.</p>
</li>
<li>
<p><strong>No connection to host USB port to connect to your phone</strong>. Using Android SDK to install and run APK on your phone will not work, as inside the Docker container we don&#8217;t see your USB devices. So commands like this will not work within the container:</p>
<div class="ulist">
<ul>
<li>
<p><code>adb devices</code></p>
</li>
<li>
<p><code>adb logcat</code></p>
</li>
<li>
<p><code>castle-engine install --target=android</code></p>
</li>
<li>
<p><code>castle-engine run --target=android</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you need these commands to work, you need to <a href="Android">install Android SDK/NDK on your regular host system</a> and work without the Docker.</p>
</div>
<div class="paragraph">
<p>+
You can also copy the APK file to your phone, and install APK by selecting it on your phone. This works, but you will not see the logs of the running application, which are quite valuable when debugging.</p>
</div>
<div class="paragraph">
<p>+
You can also use <a href="https://testfairy.com/">TestFairy integration</a> to distribute the APK. This way we can get the logs remotely, using <a href="https://github.com/castle-engine/castle-engine/blob/master/tools/build-tool/data/android/integrated-services/test_fairy/README.md">Android test_fairy service</a> or <a href="https://github.com/castle-engine/castle-engine/blob/master/tools/build-tool/data/ios/services/test_fairy/README.md">iOS test_fairy service</a>. Note that this is a paid feature of TestFairy (although you get 14-day trial).</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_updating_the_docker_image" class="sect0">Updating the Docker image</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Our <a href="https://hub.docker.com/r/kambi/castle-engine-cloud-builds-tools/">Docker image <code>kambi/castle-engine-cloud-builds-tools:cge-unstable</code></a> contains the very latest "unstable" engine version. It is updated automatically after every CGE commit. Our Jenkins runs many automated engine tests (making sure everything compiles, with various FPC versions and on various platforms), then rebuilds the <a href="https://github.com/castle-engine/castle-engine/releases/tag/snapshot">engine binary release</a> and then updates the <code>...:cge-unstable</code> Docker image.</p>
</div>
<div class="paragraph">
<p>However, note that the Docker image on your local disk, and the containers you created based on it, are not automatically updated in any way. If you want to update your image to have the latest CGE, simply do it explicitly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker pull kambi/castle-engine-cloud-builds-tools:cge-unstable</pre>
</div>
</div>
<div class="paragraph">
<p>After this, create a new container that starts from <code>kambi/castle-engine-cloud-builds-tools:cge-unstable</code> image, following the text above on this page.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Your previous images and containers will continue to exist, unmodified. The previous image is no longer tagged <code>kambi/castle-engine-cloud-builds-tools:cge-unstable</code>, but it is still there, on your disk. If you don&#8217;t want this, you can e.g. remove the unneeded containers and images. A simple way to remove everything is:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>docker ps -aq | xargs docker rm # remove all containers
docker images -q | xargs docker rmi # remove all images</pre>
</div>
</div>
<div class="paragraph">
<p><em>Note 2:</em> If you plan to update CGE often, but would still like to use Docker image (e.g. to easily get working environment to build Android APK), then another approach is to use the Docker image <code>...:cge-none</code>. This requires a bit more to set up: you should get your own <a href="https://github.com/castle-engine/castle-engine/">copy of CGE source code from GitHub</a>, keep it and update outside of Docker (using <code>git pull</code>), recompile <a href="Build Tool" class="bare">Build Tool</a> manually after updating, and manually define <code>CASTLE_ENGINE_PATH</code> inside Docker to point to your CGE copy.</p>
</div>
<div class="paragraph">
<p>This way, there is no need to update the Docker image often. The Docker image <code>...:cge-none</code> doesn&#8217;t change often. So you can use this
Docker image just to have the Android tools, texture compression tools etc.</p>
</div>
</div>
</div>
<h1 id="_sources" class="sect0">Sources</h1>
<div class="openblock partintro">
<div class="content">
The bash script, Dockerfiles, Jenkinksfiles etc. to generate these Docker images are open-source on <a href="https://github.com/castle-engine/castle-engine-cloud-builds-tools" class="bare">https://github.com/castle-engine/castle-engine-cloud-builds-tools</a> .
</div>
</div>