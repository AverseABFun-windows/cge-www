# macOS
include::common.adoc[]

## Installation of FPC and Lazarus

Just install link:http://www.lazarus.freepascal.org/[Lazarus for macOS from the official Lazarus webpage] (FPC is also included in Lazarus download).

NOTE: Alternatively you can also install FPC / Lazarus using your favourite package manager: link:https://brew.sh/[Homebrew], link:https://www.macports.org/[MacPorts], link:http://www.finkproject.org/[Fink].

The FPC compiler needs the _XCode command-line developer tools_ installed. To do this, open terminal (_/Applications/Utilities/Terminal_) and execute `xcode-select --install`.

////
The latest macOS doesn't include gdb (a debugger, user underneath by Lazarus) by default. Lazarus will warn you about this on the 1st run. You can install GDB e.g. using link:https://brew.sh/[HomeBrew], just execute `brew install gdb`.

(Lazarus now uses LLDB on macOS by default.)
////

More information:

- link:https://wiki.freepascal.org/Mac_Installation_FAQ[FPC Mac Installation FAQ]
- link:https://wiki.freepascal.org/Installing_Lazarus_on_MacOS_X[Installing Lazarus on MacOS X]

## Installation of Castle Game Engine

Just download the official binary release from link:index.php[Castle Game Engine main page]. The editor and various tools are inside the `bin/` subdirectory. Double-click the `castle-editor` application to run it.

WARNING: Editor (`castle-editor`) and other GUI tools (`view3dscene`, `castle-view-image`) are distributed as _unsigned application bundles_. Double-clicking them for the first time will result in an unhelpful error from macOS. You have to right-click on them, choose _"Open"_ from the context menu, and then you will be able to confirm that you want to run an unsigned application.

## Using TCastleWindow

Using cgeref:TCastleWindow[] on macOS is completely standard. Just run the application as usual, using _"Compile And Run"_ menu item (key shortcut is `F9`) from the editor. Alternatively, you can use `castle-engine run` on the command-line.

When creating new project in CGE editor, it will use cgeref:TCastleWindow[] by default to display a window where the engine will render.

By default, cgeref:TCastleWindow[] on macOS uses https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CocoaFundamentals/WhatIsCocoa/WhatIsCocoa.html[Cocoa] with https://developer.apple.com/documentation/appkit?language=objc[AppKit] library, coded using https://www.freepascal.org/docs-html/current/ref/refse71.html#x132-15600011.1[Objective-Pascal]. This makes it a completely native application on macOS. See link:castlewindow_backends#_cocoa_backend_castle_window_cocoa[Cocoa backend (CASTLE_WINDOW_COCOA)] overview for the features we support on macOS.

## Using TCastleControl

Using link:control_on_form[TCastleControl] on macOS is completely standard. Just drop cgeref:TCastleControl[] on LCL form.

Note that cgeref:TCastleWindow[] is more advised, as a standard way to create a window where _Castle Game Engine_ can work.

## Other libraries

OpenAL (sound):: On macOS >= 10.4, OpenAL comes already preinstalled. So sound will work automatically.

VorbisFile (reading OggVorbis):: It may be installed using link:https://www.macports.org/[MacPorts], link:https://brew.sh/[Homebrew] or link:http://www.finkproject.org/[Fink].

LibPng:: If you want to use _LibPng library_ in your programs, to read PNG faster, you can install it using link:https://www.macports.org/[MacPorts], link:https://brew.sh/[Homebrew] or  link:http://www.finkproject.org/[Fink].
+
Note that *this is not necessary*. If we don't find LibPng, we will fallback to reading PNG using _Vampyre Imaging Library_, which works too.

FreeType (reading font files):: It is available in package managers like link:https://brew.sh/[Homebrew]. As a fallback we will also try to use FreeType version installed by your X11, in `/usr/X11/lib/` .

## macOS application bundles

To run a GUI application on macOS we use _macOS application bundles_. The _application bundle_ is actually just a directory with name like `MyApplication.app` and some standard organization for executable, icons, data.

_When running the application during development_ we create a temporary application bundle, using symlinks to actual files (so it will be created lighting fast, even if you have large game data, as we will not copy data -- only symlink to it). This applies to running application from CGE editor, or when using `castle-engine run` on the command-line.

_When packaging the application_ we also create an application bundle, this time by really copying the files/dirs into proper places. This gives you `MyApplication.app` that is ready to be distributed to users. This applies when packaging from CGE editor, or when using `castle-engine package` from the command-line. You can also request the AppBundle format explicitly, using proper CGE editor menu item, or on command-line `castle-engine package --package-format=mac-app-bundle`.

NOTE: You can disable using _application bundle_ by setting `mac_app_bundle="false"` in the link:project_manifest[CastleEngineManifest.xml]. Disabling it makes sense for command-line (not GUI) applications.

Behavior of the link:manual_data_directory.php[data directory] (`castle-data:` protocol) on macOS, if the application detects it is being run through the "application bundle":

- We expect the data to be found inside `MyApplication.app/Contents/Resources/data` subdirectory. This way user can move around `MyApplication.app` to move, install and uninstall the application.
+
When creating application bundle, we (CGE editor and CGE build tool) make sure to make project data actually present there, so things should _Just Work_ and you don't need to do anything.

- If the `MyApplication.app/Contents/Resources/data` subdirectory is not found, we will use the `data` subdirectory that is sibling to `MyApplication.app`. This feature is intended to be used only *during development with Lazarus*. This way things work "out of the box" if you run through Lazarus, with checkbox _“Use Application Bundle for running and debugging”_ in Lazarus project options.

## Other macOS packaging notes

- If you need, you can add additional dynamic libraries to the bundle. If you link to them dynamically (e.g. using our `TDynLib.Load`), you should load them from a path relative to `BundlePath`, like `BundlePath + 'Contents/MacOS/libpng.dylib'`.
+
See link:http://wiki.freepascal.org/OS_X_Programming_Tips#Mac_OS_X_Libraries[macOS Libraries on FPC wiki] for general instructions how to include library inside a bundle.

- You can pack the bundle into a `.dmg` file. See link:http://el-tramo.be/guides/fancy-dmg/[Building Fancy DMG Images on macOS] for nice description how to make the directories inside dmg look pretty, so you can visually suggest user to drag your application in the _Applications_ folder.
+
Alternatively, you can pack the bundle into a _regular zip file_. link:https://daringfireball.net/2009/09/how_should_mac_apps_be_distributed[There are convincing arguments that using ZIP is actually more user-friendly than DMG] (users can just double-click to unpack, and they have the application; they don't need to understand how "disk image" works). See also link:https://stackoverflow.com/questions/3954506/dmg-or-zip-file-for-distribution-to-macs[here] for discussion. And making zip is definitely simpler.
+
Alternative method of distribution macOS applications is the  link:http://wiki.freepascal.org/Deploying_Your_Application#Using_PackageMaker_on_Mac_OS_X[package manager (.pkg)]. For normal applications (like games) the simpler `.dmg` or `.zip` are a better choice.
